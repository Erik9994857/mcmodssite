<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MC Mods & More</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <!-- Firebase Analytics -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics-compat.js"></script>
  <!-- Firebase Storage -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
  <style>
    body { background-color: #020617; }
    .prose { color: #cbd5e1; }
    .prose h1, .prose h2, .prose h3 { color: white; margin-bottom: 0.5rem; }
    .prose p { margin-bottom: 1rem; }
    .prose ul { list-style: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
    .prose li { margin-bottom: 0.25rem; }
    .hide { display: none !important; }
    .line-clamp-1 { overflow: hidden; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; }
    .line-clamp-2 { overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-spin { animation: spin 1s linear infinite; }
    .backdrop-blur-xl { backdrop-filter: blur(24px); }
    .backdrop-blur-sm { backdrop-filter: blur(4px); }
  </style>
</head>
<body class="min-h-screen text-white">
  <!-- Background effects -->
  <div class="fixed inset-0 pointer-events-none">
    <div class="absolute top-0 left-1/4 w-96 h-96 bg-purple-600/20 rounded-full blur-3xl"></div>
    <div class="absolute bottom-0 right-1/4 w-96 h-96 bg-cyan-600/20 rounded-full blur-3xl"></div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-50 border-b border-slate-800/50 bg-slate-950/80 backdrop-blur-xl">
    <div class="max-w-7xl mx-auto px-4 sm:px-6">
      <div class="flex items-center justify-between h-16">
        <a href="#" onclick="navigateTo('home'); return false;" class="flex items-center gap-2.5">
          <div class="h-9 w-9 rounded-lg bg-gradient-to-br from-purple-500 to-cyan-500 flex items-center justify-center">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
          </div>
          <span class="font-bold text-lg text-white hidden sm:block">MC Mods & More</span>
        </a>

        <nav class="hidden md:flex items-center gap-1">
          <button onclick="navigateTo('home')" class="px-4 py-2 text-slate-300 hover:text-white hover:bg-slate-800/50 rounded-lg flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            Browse
          </button>
          <button onclick="requireAuth('myMods')" class="px-4 py-2 text-slate-300 hover:text-white hover:bg-slate-800/50 rounded-lg flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
            My Mods
          </button>
          <button id="navReviewBtn" onclick="navigateTo('review')" class="hide px-4 py-2 text-slate-300 hover:text-white hover:bg-slate-800/50 rounded-lg flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
            Review Queue
          </button>
          <button onclick="navigateTo('code')" class="px-4 py-2 text-slate-300 hover:text-white hover:bg-slate-800/50 rounded-lg flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
            Code
          </button>
          <button onclick="requireAuth('publish')" class="ml-2 px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            Publish
          </button>
        </nav>

        <div class="flex items-center gap-2">
          <!-- Sign In Button (shown when not logged in) -->
          <button id="signInBtn" onclick="showAuthModal()" class="px-4 py-2 text-slate-300 hover:text-white hover:bg-slate-800/50 rounded-lg flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path></svg>
            Sign In
          </button>
          
          <!-- User Menu (shown when logged in) -->
          <div id="userMenu" class="hide relative">
            <button onclick="toggleUserMenu()" class="h-9 w-9 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center">
              <svg class="w-4 h-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
            </button>
            <div id="userDropdown" class="hide absolute right-0 mt-2 w-48 bg-slate-900 border border-slate-700 rounded-lg shadow-xl py-1 z-50">
              <div class="px-3 py-2 text-sm text-slate-400 border-b border-slate-700" id="userEmail">Guest</div>
              <button onclick="navigateTo('myMods'); toggleUserMenu();" class="w-full text-left px-3 py-2 text-slate-300 hover:bg-slate-800 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                My Mods
              </button>
              <button onclick="navigateTo('profile'); toggleUserMenu();" class="w-full text-left px-3 py-2 text-slate-300 hover:bg-slate-800 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                Profile
              </button>
              <button onclick="handleLogout()" class="w-full text-left px-3 py-2 text-red-400 hover:bg-slate-800 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                Sign Out
              </button>
            </div>
          </div>
          <button onclick="toggleMobileMenu()" class="md:hidden p-2 text-slate-300 hover:bg-slate-800/50 rounded-lg">
            <svg id="menuIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Mobile menu -->
    <div id="mobileMenu" class="hide md:hidden border-t border-slate-800/50 bg-slate-950/95 backdrop-blur-xl">
      <div class="px-4 py-4 space-y-2">
        <button onclick="navigateTo('home'); toggleMobileMenu();" class="w-full text-left flex items-center gap-2 px-3 py-2 rounded-lg text-slate-300 hover:bg-slate-800/50">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
          Browse Mods
        </button>
        <button onclick="requireAuth('myMods'); toggleMobileMenu();" class="w-full text-left flex items-center gap-2 px-3 py-2 rounded-lg text-slate-300 hover:bg-slate-800/50">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
          My Mods
        </button>
        <button id="mobileReviewBtn" onclick="navigateTo('review'); toggleMobileMenu();" class="hide w-full text-left flex items-center gap-2 px-3 py-2 rounded-lg text-slate-300 hover:bg-slate-800/50">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
          Review Queue
        </button>
        <button onclick="navigateTo('code'); toggleMobileMenu();" class="w-full text-left flex items-center gap-2 px-3 py-2 rounded-lg text-slate-300 hover:bg-slate-800/50">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
          Code
        </button>
        <button onclick="requireAuth('publish'); toggleMobileMenu();" class="w-full text-left flex items-center gap-2 px-3 py-2 rounded-lg bg-purple-600 text-white">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
          Publish Mod
        </button>
      </div>
    </div>
  </header>

  <!-- Main content -->
  <main id="mainContent" class="relative"></main>

  <!-- Footer -->
  <footer class="relative border-t border-slate-800/50 mt-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-8">
      <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
        <div class="flex items-center gap-2">
          <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
          <span class="text-slate-400">Minecraft Mods/Plugins/Addons And More!</span>
        </div>
        <p class="text-sm text-slate-500">Share and discover amazing Minecraft content</p>
      </div>
    </div>
  </footer>

  <!-- Auth Modal (Sign In / Sign Up) -->
  <div id="authModal" class="hide fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
    <div class="bg-slate-900 border border-slate-700 rounded-xl p-6 w-full max-w-md mx-4">
      <h3 class="text-xl font-bold text-white mb-2">Sign In</h3>
      <p class="text-slate-400 text-sm mb-6">Enter your credentials to sign in. If you don't have an account, one will be created for you.</p>
      
      <div class="space-y-4">
        <div>
          <label class="block text-white text-sm mb-2">Email *</label>
          <input type="email" id="authEmail" placeholder="your@email.com" 
            class="w-full px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-white placeholder:text-slate-500 outline-none focus:border-purple-500" />
        </div>
        
        <div>
          <label class="block text-white text-sm mb-2">Password *</label>
          <div class="relative">
            <input type="password" id="authPassword" placeholder="Enter your password" 
              class="w-full px-4 py-2 pr-12 bg-slate-800/50 border border-slate-700 rounded-lg text-white placeholder:text-slate-500 outline-none focus:border-purple-500" />
            <button type="button" onclick="togglePasswordVisibility()" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white">
              <svg id="eyeIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
              <svg id="eyeOffIcon" class="w-5 h-5 hide" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path></svg>
            </button>
          </div>
        </div>
        
        <div>
          <label class="block text-white text-sm mb-2">Admin Code <span class="text-slate-500">(optional)</span></label>
          <input type="text" id="authAdminCode" placeholder="Enter admin code if you have one" 
            class="w-full px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-white placeholder:text-slate-500 outline-none focus:border-purple-500" />
          <p class="text-slate-500 text-xs mt-1">Leave empty if you're not an admin</p>
        </div>
      </div>
      
      <div id="authError" class="hide text-red-400 text-sm mt-4"></div>
      
      <div class="flex gap-3 justify-end mt-6">
        <button onclick="hideAuthModal()" class="px-4 py-2 border border-slate-700 text-white rounded-lg hover:bg-slate-800">Cancel</button>
        <button onclick="handleAuth()" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path></svg>
          Sign In
        </button>
      </div>
    </div>
  </div>


  <!-- Toast notification -->
  <div id="toast" class="hide fixed bottom-4 right-4 z-50 px-4 py-3 rounded-lg shadow-xl flex items-center gap-2"></div>

  <script>
    // ==================== FIREBASE CONFIGURATION ====================
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCDA92poHMLxznozl8lsDJnYXbCUSwV1_o",
      authDomain: "mcmodsandmore-1b476.firebaseapp.com",
      projectId: "mcmodsandmore-1b476",
      storageBucket: "mcmodsandmore-1b476.firebasestorage.app",
      messagingSenderId: "183552735102",
      appId: "1:183552735102:web:c0953bb60ed4083173252f",
      measurementId: "G-H1HL5ZVKPE"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const analytics = firebase.analytics(app);
    const storage = firebase.storage(app);

    // ==================== DATA STORAGE ====================
    const STORAGE_KEYS = {
      MODS: 'mc_mods',
      VERSIONS: 'mc_versions',
      USERS: 'mc_users',
      CURRENT_USER: 'mc_current_user',
      IS_ADMIN: 'mc_is_admin'
    };

    // The one and only admin code
    const ADMIN_CODE = '36h1j6h7n2h1jdsef9gd7s';

    function getStoredData(key, defaultValue = []) {
      try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : defaultValue;
      } catch {
        return defaultValue;
      }
    }

    function setStoredData(key, data) {
      localStorage.setItem(key, JSON.stringify(data));
    }

    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    // Get current logged in user
    function getCurrentUser() {
      return getStoredData(STORAGE_KEYS.CURRENT_USER, null);
    }

    function isLoggedIn() {
      return getCurrentUser() !== null;
    }

    // Initialize default data if empty
    function initializeData() {
      // Try to load data from persistent storage first (for update resilience)
      const persistentMods = getPersistentData('minecraft_mods');
      const persistentVersions = getPersistentData('minecraft_versions');
      const persistentUsers = getPersistentData('minecraft_users');

      if (persistentMods) {
        setStoredData(STORAGE_KEYS.MODS, persistentMods);
      } else if (!localStorage.getItem(STORAGE_KEYS.MODS)) {
        const sampleMods = [
          {
            id: 'sample1',
            title: 'Better Caves',
            short_description: 'Completely overhauls cave generation with stunning new biomes and structures',
            full_description: '# Better Caves\n\nThis mod completely transforms the underground experience!\n\n## Features\n- New cave biomes\n- Underground lakes\n- Crystal formations\n- Rare minerals',
            category: 'java_mod',
            tags: ['caves', 'world-gen', 'exploration'],
            thumbnail_url: '',
            screenshots: [],
            download_count: 15420,
            minecraft_versions: ['1.20.1', '1.19.4'],
            author_name: 'CaveMaster',
            author_id: 'user1',
            status: 'published',
            created_date: new Date(Date.now() - 86400000 * 5).toISOString()
          },
          {
            id: 'sample2',
            title: 'Faithful 32x',
            short_description: 'A higher resolution version of the default Minecraft textures',
            full_description: '# Faithful 32x\n\nThe classic texture pack that stays true to vanilla while enhancing detail.',
            category: 'texture_pack',
            tags: ['faithful', '32x', 'vanilla'],
            thumbnail_url: '',
            screenshots: [],
            download_count: 89230,
            minecraft_versions: ['BE 1.21.0', 'BE 1.20.80'],
            author_name: 'FaithfulTeam',
            author_id: 'user2',
            status: 'published',
            created_date: new Date(Date.now() - 86400000 * 10).toISOString()
          },
          {
            id: 'sample3',
            title: 'Essentials Plugin',
            short_description: 'The essential plugin for any Minecraft server with tons of features',
            full_description: '# EssentialsX\n\nThe essential plugin suite for Spigot/Paper servers.',
            category: 'plugin',
            tags: ['essentials', 'commands', 'economy'],
            thumbnail_url: '',
            screenshots: [],
            download_count: 256000,
            minecraft_versions: ['1.20.4', '1.20.1', '1.19.4'],
            author_name: 'EssentialsTeam',
            author_id: 'user3',
            status: 'published',
            created_date: new Date(Date.now() - 86400000 * 2).toISOString()
          }
        ];
        setStoredData(STORAGE_KEYS.MODS, sampleMods);

        const sampleVersions = [
          {
            id: 'v1',
            mod_id: 'sample1',
            version_number: '2.0.0',
            changelog: 'Major update with new cave types',
            minecraft_versions: ['1.20.1'],
            platforms: ['forge', 'fabric'],
            files: [{ platform: 'forge', download_url: '#', file_name: 'bettercaves-2.0.0-forge.jar' }],
            is_latest: true,
            created_date: new Date().toISOString()
          }
        ];
        setStoredData(STORAGE_KEYS.VERSIONS, sampleVersions);
      }

      if (persistentUsers) {
        setStoredData(STORAGE_KEYS.USERS, persistentUsers);
      } else if (!localStorage.getItem(STORAGE_KEYS.USERS)) {
        setStoredData(STORAGE_KEYS.USERS, []);
      }
    }

    // Save data to persistent storage periodically to ensure update resilience
    function savePersistentData() {
      // Save current data to persistent storage
      const mods = getStoredData(STORAGE_KEYS.MODS, []);
      const versions = getStoredData(STORAGE_KEYS.VERSIONS, []);
      const users = getStoredData(STORAGE_KEYS.USERS, []);

      storePersistentData('minecraft_mods', mods);
      storePersistentData('minecraft_versions', versions);
      storePersistentData('minecraft_users', users);

      // Also save projects if they exist
      const projects = JSON.parse(localStorage.getItem('savedProjects') || '{}');
      if (Object.keys(projects).length > 0) {
        storePersistentData('minecraft_projects', projects);
      }
    }

    // ==================== CATEGORIES & CONFIG ====================
    const categories = [
      { value: 'all', label: 'All', icon: 'grid' },
      { value: 'addon', label: 'Addons', icon: 'package' },
      { value: 'java_mod', label: 'Java Mods', icon: 'coffee' },
      { value: 'plugin', label: 'Plugins', icon: 'plug' },
      { value: 'texture_pack', label: 'Textures', icon: 'palette' },
      { value: 'shader', label: 'Shaders', icon: 'sparkles' },
      { value: 'map', label: 'Maps', icon: 'map' },
      { value: 'skin_pack', label: 'Skins', icon: 'users' },
      { value: 'behavior_pack', label: 'Behaviors', icon: 'boxes' },
      { value: 'resource_pack', label: 'Resources', icon: 'folder' }
    ];

    const categoryStyles = {
      addon: 'bg-purple-500/20 text-purple-300 border-purple-500/30',
      texture_pack: 'bg-cyan-500/20 text-cyan-300 border-cyan-500/30',
      shader: 'bg-amber-500/20 text-amber-300 border-amber-500/30',
      map: 'bg-emerald-500/20 text-emerald-300 border-emerald-500/30',
      skin_pack: 'bg-pink-500/20 text-pink-300 border-pink-500/30',
      behavior_pack: 'bg-blue-500/20 text-blue-300 border-blue-500/30',
      resource_pack: 'bg-orange-500/20 text-orange-300 border-orange-500/30',
      java_mod: 'bg-red-500/20 text-red-300 border-red-500/30',
      plugin: 'bg-green-500/20 text-green-300 border-green-500/30'
    };

    const categoryLabels = {
      addon: 'Addon', texture_pack: 'Texture Pack', shader: 'Shader', map: 'Map',
      skin_pack: 'Skin Pack', behavior_pack: 'Behavior Pack', resource_pack: 'Resource Pack',
      java_mod: 'Java Mod', plugin: 'Plugin'
    };

    const JAVA_MOD_PLATFORMS = [
      { value: 'forge', label: 'Forge' }, { value: 'fabric', label: 'Fabric' },
      { value: 'neoforge', label: 'NeoForge' }, { value: 'quilt', label: 'Quilt' }
    ];

    const PLUGIN_PLATFORMS = [
      { value: 'spigot', label: 'Spigot' }, { value: 'paper', label: 'Paper' },
      { value: 'bukkit', label: 'Bukkit' }, { value: 'velocity', label: 'Velocity' }
    ];

    const ALL_MC_VERSIONS = [
      // Latest Java Edition versions
      '1.21.10', '1.21.9', '1.21.8', '1.21.7', '1.21.6', '1.21.5', '1.21.4', '1.21.3', '1.21.2', '1.21.1', '1.21',
      '1.20.6', '1.20.5', '1.20.4', '1.20.2', '1.20.1', '1.20',
      '1.19.4', '1.19.3', '1.19.2', '1.19.1', '1.19',
      '1.18.2', '1.18.1', '1.18',
      '1.17.1', '1.17',
      '1.16.5', '1.16.4', '1.16.3', '1.16.2', '1.16.1',
      '1.15.2', '1.15.1', '1.15',
      '1.14.4', '1.14.3', '1.14.2', '1.14.1', '1.14',
      '1.13.2', '1.13.1', '1.13',
      '1.12.2', '1.12.1', '1.12',
      '1.11.2', '1.11.1', '1.11',
      '1.10.2', '1.10.1', '1.10',
      '1.9.4', '1.9.2', '1.9.1', '1.9',
      '1.8.9', '1.8.8', '1.8.7', '1.8.6', '1.8.5', '1.8.4', '1.8.3', '1.8.2', '1.8.1', '1.8',

      // Bedrock Edition versions
      'BE 1.21.50', 'BE 1.21.41', 'BE 1.21.40', 'BE 1.21.30', 'BE 1.21.21', 'BE 1.21.20', 'BE 1.21.2',
      'BE 1.21.1', 'BE 1.21.0',
      'BE 1.20.81', 'BE 1.20.80', 'BE 1.20.71', 'BE 1.20.70', 'BE 1.20.62', 'BE 1.20.60', 'BE 1.20.50',
      'BE 1.20.41', 'BE 1.20.40', 'BE 1.20.31', 'BE 1.20.30',
      'BE 1.19.81', 'BE 1.19.80', 'BE 1.19.71', 'BE 1.19.70', 'BE 1.19.63', 'BE 1.19.62', 'BE 1.19.60',
      'BE 1.19.51', 'BE 1.19.50', 'BE 1.19.41', 'BE 1.19.40', 'BE 1.19.31', 'BE 1.19.30', 'BE 1.19.23',
      'BE 1.19.22', 'BE 1.19.21', 'BE 1.19.20', 'BE 1.19.11', 'BE 1.19.10', 'BE 1.19.1', 'BE 1.19.0'
    ];

    // ==================== STATE ====================
    let currentPage = 'home';
    let currentModId = null;
    let searchTerm = '';
    let selectedCategory = 'all';
    let sortBy = 'recent';
    let publishStep = 1;
    let publishData = {};
    let versionData = {};
    let pendingNavigation = null;
    let uploadedFiles = [];
    let autoSaveTimer = null;

    // ==================== AUTHENTICATION ====================
    function showAuthModal() {
      document.getElementById('authModal').classList.remove('hide');
      document.getElementById('authEmail').value = '';
      document.getElementById('authPassword').value = '';
      document.getElementById('authAdminCode').value = '';
      document.getElementById('authError').classList.add('hide');
      document.getElementById('authPassword').type = 'password';
      document.getElementById('eyeIcon').classList.remove('hide');
      document.getElementById('eyeOffIcon').classList.add('hide');
    }

    function hideAuthModal() {
      document.getElementById('authModal').classList.add('hide');
      pendingNavigation = null;
    }

    function togglePasswordVisibility() {
      const passwordInput = document.getElementById('authPassword');
      const eyeIcon = document.getElementById('eyeIcon');
      const eyeOffIcon = document.getElementById('eyeOffIcon');
      
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        eyeIcon.classList.add('hide');
        eyeOffIcon.classList.remove('hide');
      } else {
        passwordInput.type = 'password';
        eyeIcon.classList.remove('hide');
        eyeOffIcon.classList.add('hide');
      }
    }

    function handleAuth() {
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value;
      const adminCode = document.getElementById('authAdminCode').value.trim();
      const errorEl = document.getElementById('authError');

      // Validation
      if (!email || !password) {
        errorEl.textContent = 'Please enter both email and password';
        errorEl.classList.remove('hide');
        return;
      }

      if (!email.includes('@')) {
        errorEl.textContent = 'Please enter a valid email address';
        errorEl.classList.remove('hide');
        return;
      }

      if (password.length < 4) {
        errorEl.textContent = 'Password must be at least 4 characters';
        errorEl.classList.remove('hide');
        return;
      }

      // Get all users
      const users = getStoredData(STORAGE_KEYS.USERS, []);
      let user = users.find(u => u.email === email);
      let isNewUser = false;

      if (user) {
        // Existing user - check password
        if (user.password !== password) {
          errorEl.textContent = 'Incorrect password';
          errorEl.classList.remove('hide');
          return;
        }

        // Ensure we're using the latest user data that includes admin status
        // The user variable already contains the data from storage which should have the correct admin status
      } else {
        // Check if email already exists (this shouldn't happen since user was null, but double-check)
        const allUsers = getStoredData(STORAGE_KEYS.USERS, []);
        const emailExists = allUsers.some(u => u.email === email);
        if (emailExists) {
          errorEl.textContent = 'This email is already registered to another account';
          errorEl.classList.remove('hide');
          return;
        }

        // New user - create account
        isNewUser = true;
        user = {
          id: generateId(),
          email: email,
          password: password,
          full_name: email.split('@')[0],
          avatar_url: '',
          paypal_link: '',
          discord_link: '',
          is_admin: false,
          created_date: new Date().toISOString()
        };
      }

      // Check admin code - grant admin permanently if valid code provided
      let adminStatusChanged = false;
      if (adminCode) {
        if (adminCode === ADMIN_CODE) {
          user.is_admin = true;
          adminStatusChanged = true;
          showToast('Admin access granted permanently!', 'success');
        } else {
          errorEl.textContent = 'Invalid admin code';
          errorEl.classList.remove('hide');
          return;
        }
      }

      // Save user to users list
      if (isNewUser) {
        users.push(user);
        showToast('Account created successfully!', 'success');
      } else {
        // Update existing user in case admin status changed
        const userIndex = users.findIndex(u => u.id === user.id);
        if (userIndex !== -1) {
          if (adminStatusChanged) {
            // If admin status was changed, update it in the global users list
            users[userIndex] = {
              ...user,
              is_admin: true // Set admin to true since code was provided
            };
          } else {
            // Otherwise preserve the existing admin status
            const existingAdminStatus = users[userIndex].is_admin;
            // Update the user data but preserve the admin status in the global list
            users[userIndex] = {
              ...user,
              is_admin: existingAdminStatus // Preserve existing admin status
            };
          }
        }
      }
      setStoredData(STORAGE_KEYS.USERS, users);

      // Set current user and admin status (admin is now tied to account)
      setStoredData(STORAGE_KEYS.CURRENT_USER, user);
      // Set admin status based on user's stored admin status
      setStoredData(STORAGE_KEYS.IS_ADMIN, user.is_admin || false);
      
      // Start auto-sync
      startAutoSync();

      hideAuthModal();
      updateAuthUI();
      
      // Navigate to pending page if any
      if (pendingNavigation) {
        navigateTo(pendingNavigation);
        pendingNavigation = null;
      } else {
        renderPage();
      }

      showToast(`Welcome back, ${user.full_name}!`, 'success');
    }

    function handleLogout() {
      // One final save before logout
      syncDataToStorage();
      stopAutoSync();
      
      localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
      localStorage.removeItem(STORAGE_KEYS.IS_ADMIN);
      document.getElementById('userDropdown').classList.add('hide');
      updateAuthUI();
      navigateTo('home');
      showToast('Signed out successfully', 'success');
    }

    function startAutoSync() {
      if (autoSaveTimer) clearInterval(autoSaveTimer);
      // Auto-save every 4 seconds
      autoSaveTimer = setInterval(() => {
        if (isLoggedIn()) {
          syncDataToStorage();
          // Optional: visual indicator or console log
          // console.log('Data auto-synced');
        }
      }, 4000);
    }

    function stopAutoSync() {
      if (autoSaveTimer) {
        clearInterval(autoSaveTimer);
        autoSaveTimer = null;
      }
    }

    function syncDataToStorage() {
      // In a real backend scenario, this is where we would POST to the server.
      // Since we are using LocalStorage as our "Cloud", we just ensure everything is committed.
      // We retrieve current memory state and re-save it to ensure consistency.
      const mods = getStoredData(STORAGE_KEYS.MODS, []);
      const users = getStoredData(STORAGE_KEYS.USERS, []);
      const versions = getStoredData(STORAGE_KEYS.VERSIONS, []);
      const user = getCurrentUser();

      // Ensure current user's data (including files, admin status, projects) is synchronized with global users list
      if (user) {
        const userIndex = users.findIndex(u => u.id === user.id);
        if (userIndex !== -1) {
          // Merge current user data with stored user data to preserve admin status and other properties
          const adminStatus = users[userIndex].is_admin; // Get admin status from stored data
          users[userIndex] = {
            ...user, // Update with current session data
            is_admin: adminStatus, // Use admin status from stored data
            files: user.files || users[userIndex].files || [], // Preserve current files
            projects: user.projects || users[userIndex].projects || [], // Preserve projects if any
            password: users[userIndex].password // Preserve password from stored data
          };
          // Update admin storage to match
          setStoredData(STORAGE_KEYS.IS_ADMIN, adminStatus);
        } else {
          // If user not found in global list, add them (this shouldn't happen under normal circumstances)
          users.push(user);
        }
        setStoredData(STORAGE_KEYS.USERS, users);
      }

      // Simulate "Cloud" update by ensuring all data is fresh
      setStoredData(STORAGE_KEYS.MODS, mods);
      setStoredData(STORAGE_KEYS.VERSIONS, versions);
      if (user) setStoredData(STORAGE_KEYS.CURRENT_USER, user);
    }

    function requireAuth(page) {
      if (isLoggedIn()) {
        navigateTo(page);
      } else {
        pendingNavigation = page;
        showAuthModal();
      }
    }

    function updateAuthUI() {
      const signInBtn = document.getElementById('signInBtn');
      const userMenu = document.getElementById('userMenu');
      const userEmail = document.getElementById('userEmail');
      const user = getCurrentUser();

      if (user) {
        signInBtn.classList.add('hide');
        userMenu.classList.remove('hide');
        userEmail.textContent = user.full_name || user.email;
      } else {
        signInBtn.classList.remove('hide');
        userMenu.classList.add('hide');
      }

      updateAdminUI();
    }

    // ==================== NAVIGATION ====================
    function navigateTo(page, params = {}) {
      currentPage = page;
      if (params.modId) currentModId = params.modId;
      renderPage();
      window.scrollTo(0, 0);
    }

    function renderPage() {
      const content = document.getElementById('mainContent');
      switch (currentPage) {
        case 'home': content.innerHTML = renderHome(); break;
        case 'detail': content.innerHTML = renderModDetail(); break;
        case 'publish': content.innerHTML = renderPublish(); break;
        case 'myMods': content.innerHTML = renderMyMods(); break;
        case 'profile': content.innerHTML = renderProfile(); break;
        case 'review': content.innerHTML = renderReviewQueue(); break;
        case 'edit': content.innerHTML = renderEditMod(); break;
        case 'code': content.innerHTML = renderCodeIDE(); break;
        default: content.innerHTML = renderHome();
      }
      updateAdminUI();
    }

    // ==================== UI HELPERS ====================
    function toggleUserMenu() {
      document.getElementById('userDropdown').classList.toggle('hide');
    }

    function toggleMobileMenu() {
      document.getElementById('mobileMenu').classList.toggle('hide');
    }

    function updateAdminUI() {
      const isAdmin = getStoredData(STORAGE_KEYS.IS_ADMIN, false);
      const navReviewBtn = document.getElementById('navReviewBtn');
      const mobileReviewBtn = document.getElementById('mobileReviewBtn');
      
      if (isAdmin) {
        navReviewBtn.classList.remove('hide');
        mobileReviewBtn.classList.remove('hide');
      } else {
        navReviewBtn.classList.add('hide');
        mobileReviewBtn.classList.add('hide');
      }
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.className = `fixed bottom-4 right-4 z-50 px-4 py-3 rounded-lg shadow-xl flex items-center gap-2 ${
        type === 'success' ? 'bg-emerald-600' : type === 'error' ? 'bg-red-600' : 'bg-slate-700'
      }`;
      toast.innerHTML = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          ${type === 'success' 
            ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>'
            : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>'
          }
        </svg>
        <span class="text-white">${message}</span>
      `;
      toast.classList.remove('hide');
      setTimeout(() => toast.classList.add('hide'), 3000);
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function compressVersions(versions) {
      if (!versions || versions.length === 0) return null;
      if (versions.length === 1) return versions[0];
      if (versions.length > 2) return `${versions[0]} - ${versions[versions.length - 1]}`;
      return versions.join(', ');
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#userMenu')) {
        document.getElementById('userDropdown').classList.add('hide');
      }
    });

    // ==================== HOME PAGE ====================
    function renderHome() {
      const mods = getStoredData(STORAGE_KEYS.MODS, [])
        .filter(m => m.status === 'published');
      
      let filtered = [...mods];
      
      if (selectedCategory !== 'all') {
        filtered = filtered.filter(m => m.category === selectedCategory);
      }
      
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        filtered = filtered.filter(m => 
          m.title?.toLowerCase().includes(term) ||
          m.short_description?.toLowerCase().includes(term) ||
          m.tags?.some(t => t.toLowerCase().includes(term))
        );
      }
      
      if (sortBy === 'popular') {
        filtered.sort((a, b) => (b.download_count || 0) - (a.download_count || 0));
      } else {
        filtered.sort((a, b) => new Date(b.created_date) - new Date(a.created_date));
      }

      return `
        <div class="max-w-7xl mx-auto px-4 sm:px-6 py-8">
          <!-- Hero -->
          <div class="text-center mb-12">
            <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-purple-500/10 border border-purple-500/20 text-purple-300 text-sm mb-6">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
              Discover amazing Minecraft content
            </div>
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">
              Minecraft<span class="bg-gradient-to-r from-purple-400 to-cyan-400 bg-clip-text text-transparent"> Mods & More</span>
            </h1>
            <p class="text-lg text-slate-400 max-w-2xl mx-auto">Browse, download, and share the best mods, addons, plugins, texture packs, shaders, and more</p>
          </div>

          <!-- Search -->
          <div class="max-w-2xl mx-auto mb-8">
            <div class="relative">
              <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
              <input type="text" value="${searchTerm}" onkeyup="handleSearch(event)" placeholder="Search mods, addons, textures..."
                class="w-full pl-12 pr-10 h-12 bg-slate-900/60 border border-slate-700/50 text-white placeholder:text-slate-500 focus:border-purple-500/50 rounded-xl outline-none" />
              ${searchTerm ? `<button onclick="clearSearch()" class="absolute right-3 top-1/2 -translate-y-1/2 p-1 text-slate-400 hover:text-white"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>` : ''}
            </div>
          </div>

          <!-- Filters -->
          <div class="mb-8">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
              <div class="flex flex-wrap gap-2">
                ${categories.map(cat => `
                  <button onclick="filterByCategory('${cat.value}')"
                    class="h-10 px-4 rounded-xl transition-all duration-200 flex items-center gap-2 ${
                      selectedCategory === cat.value
                        ? 'bg-purple-500/20 text-purple-300 border border-purple-500/50'
                        : 'bg-slate-800/50 text-slate-400 border border-slate-700/50 hover:bg-slate-800 hover:text-white'
                    }">
                    ${cat.label}
                  </button>
                `).join('')}
              </div>
              <div class="flex items-center gap-2">
                <button onclick="setSortBy('recent')" class="px-3 py-2 rounded-lg flex items-center gap-1.5 ${sortBy === 'recent' ? 'bg-slate-800 text-white' : 'text-slate-400 hover:text-white'}">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                  Recent
                </button>
                <button onclick="setSortBy('popular')" class="px-3 py-2 rounded-lg flex items-center gap-1.5 ${sortBy === 'popular' ? 'bg-slate-800 text-white' : 'text-slate-400 hover:text-white'}">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                  Popular
                </button>
              </div>
            </div>
          </div>

          <!-- Count -->
          <div class="flex items-center justify-between mb-6">
            <p class="text-sm text-slate-400">${filtered.length} ${filtered.length === 1 ? 'mod' : 'mods'} found</p>
          </div>

          <!-- Grid -->
          ${filtered.length === 0 ? `
            <div class="text-center py-20">
              <svg class="w-16 h-16 mx-auto text-slate-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
              <h3 class="text-xl font-medium text-white mb-2">No mods found</h3>
              <p class="text-slate-400">${searchTerm || selectedCategory !== 'all' ? 'Try adjusting your search or filters' : 'Be the first to publish a mod!'}</p>
            </div>
          ` : `
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
              ${filtered.map(mod => renderModCard(mod)).join('')}
            </div>
          `}
        </div>
      `;
    }

    function renderModCard(mod) {
      const versions = getStoredData(STORAGE_KEYS.VERSIONS, []).filter(v => v.mod_id === mod.id);
      const latestVersion = versions.find(v => v.is_latest);
      const mcVersions = latestVersion?.minecraft_versions || mod.minecraft_versions;
      
      return `
        <div class="group cursor-pointer" onclick="navigateTo('detail', { modId: '${mod.id}' })">
          <div class="bg-slate-900/60 border border-slate-700/50 rounded-xl overflow-hidden hover:border-purple-500/50 transition-all duration-300 hover:-translate-y-1">
            <div class="relative aspect-video overflow-hidden bg-slate-800">
              ${mod.thumbnail_url
                ? getThumbnailSrc(mod.thumbnail_url)
                : `<div class="w-full h-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center"><span class="text-white font-bold text-center px-4">${mod.title}</span></div>`
              }
              <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent"></div>
              <span class="absolute top-3 left-3 px-2 py-1 text-xs rounded-md border ${categoryStyles[mod.category]}">${categoryLabels[mod.category]}</span>
            </div>
            <div class="p-4 space-y-2">
              <h3 class="font-semibold text-white text-lg line-clamp-1 group-hover:text-purple-300 transition-colors">${mod.title}</h3>
              <div class="min-h-[40px]">
                <p class="text-slate-400 text-sm line-clamp-2 leading-relaxed">${mod.short_description}</p>
                ${mcVersions?.length > 0 ? `<p class="text-white text-xs mt-1">MC ${compressVersions(mcVersions)}</p>` : ''}
              </div>
              <div class="flex items-center justify-between pt-2">
                <div class="flex items-center gap-1.5 text-slate-400 text-sm">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                  <span>${(mod.download_count || 0).toLocaleString()}</span>
                </div>
                <div class="flex items-center gap-1 text-purple-400 text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity">
                  View <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function handleSearch(event) {
      searchTerm = event.target.value;
      if (event.key === 'Enter') renderPage();
      // Debounced search
      clearTimeout(window.searchTimeout);
      window.searchTimeout = setTimeout(() => renderPage(), 300);
    }

    function clearSearch() {
      searchTerm = '';
      renderPage();
    }

    function filterByCategory(cat) {
      selectedCategory = cat;
      renderPage();
    }

    function setSortBy(sort) {
      sortBy = sort;
      renderPage();
    }

    // ==================== MOD DETAIL PAGE ====================
    function renderModDetail() {
      const mods = getStoredData(STORAGE_KEYS.MODS, []);
      const mod = mods.find(m => m.id === currentModId);
      
      if (!mod) {
        return `
          <div class="max-w-4xl mx-auto px-4 sm:px-6 py-12 text-center">
            <h2 class="text-2xl font-bold text-white mb-4">Mod not found</h2>
            <button onclick="navigateTo('home')" class="px-4 py-2 border border-slate-700 text-slate-300 rounded-lg hover:bg-slate-800">
              ‚Üê Back to Browse
            </button>
          </div>
        `;
      }

      const versions = getStoredData(STORAGE_KEYS.VERSIONS, []).filter(v => v.mod_id === mod.id);
      const user = getCurrentUser();
      const isOwner = user && user.id === mod.author_id;

      return `
        <div class="max-w-6xl mx-auto px-4 sm:px-6 py-8">
          <button onclick="navigateTo('home')" class="inline-flex items-center text-slate-300 hover:text-white mb-6 transition-colors">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            Back to Browse
          </button>

          <!-- Header -->
          <div class="flex items-start gap-4 mb-8">
            ${mod.thumbnail_url
              ? getThumbnailSrcForSize(mod.thumbnail_url, '20', '20')
              : `<div class="w-20 h-20 rounded-xl flex-shrink-0 bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center"><span class="text-white font-bold text-xs text-center px-2">${mod.title}</span></div>`
            }
            <div class="flex-1 min-w-0">
              <div class="flex items-start justify-between gap-4">
                <div>
                  <span class="inline-block px-2 py-1 text-xs rounded-md border mb-2 ${categoryStyles[mod.category]}">${categoryLabels[mod.category]}</span>
                  <h1 class="text-2xl md:text-3xl font-bold text-white">${mod.title}</h1>
                  <p class="text-slate-400 mt-1">${mod.short_description}</p>
                </div>
                ${isOwner ? `
                  <button onclick="navigateTo('edit', { modId: '${mod.id}' })" class="px-4 py-2 bg-white hover:bg-slate-200 text-black rounded-lg flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    Edit
                  </button>
                ` : ''}
              </div>
              <div class="flex items-center gap-4 mt-3 text-sm text-slate-500">
                <span class="flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                  ${mod.author_name || 'Anonymous'}
                </span>
                <span class="flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                  ${formatDate(mod.created_date)}
                </span>
                <span class="flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                  ${(mod.download_count || 0).toLocaleString()}
                </span>
              </div>
              ${mod.tags?.length > 0 ? `
                <div class="flex flex-wrap gap-2 mt-3">
                  ${mod.tags.map(tag => `
                    <span class="px-2 py-1 text-xs rounded-md border border-slate-600 text-slate-400 flex items-center gap-1">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path></svg>
                      ${tag}
                    </span>
                  `).join('')}
                </div>
              ` : ''}
            </div>
          </div>

          <!-- Tabs -->
          <div class="border-b border-slate-700/50 mb-6">
            <div class="flex gap-1">
              <button onclick="setDetailTab('description')" id="tab-description" class="px-4 py-3 text-purple-300 border-b-2 border-purple-500 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                Description
              </button>
              <button onclick="setDetailTab('versions')" id="tab-versions" class="px-4 py-3 text-slate-400 hover:text-white flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                Versions
              </button>
              <button onclick="setDetailTab('download')" id="tab-download" class="px-4 py-3 text-slate-400 hover:text-white flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                Download
              </button>
            </div>
          </div>

          <!-- Tab Content -->
          <div id="detail-content">
            ${renderDescriptionTab(mod)}
          </div>
        </div>
      `;
    }

    let currentDetailTab = 'description';

    function setDetailTab(tab) {
      currentDetailTab = tab;
      const mods = getStoredData(STORAGE_KEYS.MODS, []);
      const mod = mods.find(m => m.id === currentModId);
      const versions = getStoredData(STORAGE_KEYS.VERSIONS, []).filter(v => v.mod_id === currentModId);
      
      // Update tab styles
      ['description', 'versions', 'download'].forEach(t => {
        const tabEl = document.getElementById(`tab-${t}`);
        if (t === tab) {
          tabEl.className = 'px-4 py-3 text-purple-300 border-b-2 border-purple-500 flex items-center gap-2';
        } else {
          tabEl.className = 'px-4 py-3 text-slate-400 hover:text-white flex items-center gap-2';
        }
      });

      const content = document.getElementById('detail-content');
      switch (tab) {
        case 'description': content.innerHTML = renderDescriptionTab(mod); break;
        case 'versions': content.innerHTML = renderVersionsTab(versions, mod); break;
        case 'download': content.innerHTML = renderDownloadTab(versions, mod); break;
      }
    }

    function renderDescriptionTab(mod) {
      // Simple markdown-like rendering
      let description = mod.full_description || mod.short_description || 'No description available.';
      description = description
        .replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold text-white mt-4 mb-2">$1</h3>')
        .replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold text-white mt-6 mb-3">$1</h2>')
        .replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold text-white mt-6 mb-3">$1</h1>')
        .replace(/\*\*(.*?)\*\*/g, '<strong class="text-white">$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/^- (.*$)/gim, '<li class="ml-4">$1</li>')
        .replace(/\n/g, '<br>');

      return `
        <div class="bg-slate-900/60 border border-slate-700/50 rounded-xl p-6">
          <div class="prose max-w-none">${description}</div>
        </div>
      `;
    }

    function renderVersionsTab(versions, mod) {
      const user = getCurrentUser();
      const isOwner = user && user.id === mod.author_id;

      if (versions.length === 0) {
        return `
          <div class="bg-slate-900/60 border border-slate-700/50 rounded-xl p-6">
            <p class="text-slate-400 text-center py-8">No versions available yet</p>
            ${isOwner ? `
              <div class="mt-6 text-center">
                <button onclick="showNewVersionModal('${mod.id}')" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg flex items-center gap-2 mx-auto">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                  Upload First Version
                </button>
              </div>
            ` : ''}
          </div>
        `;
      }

      return `
        <div class="bg-slate-900/60 border border-slate-700/50 rounded-xl p-6 space-y-4">
          ${versions.map(version => `
            <div class="flex items-center justify-between p-4 bg-slate-800/50 rounded-lg border border-slate-700/50">
              <div>
                <div class="flex items-center gap-2">
                  <span class="font-semibold text-white">v${version.version_number}</span>
                  ${version.is_latest ? '<span class="px-2 py-0.5 text-xs rounded-md bg-emerald-500/20 text-emerald-300 border border-emerald-500/30">Latest</span>' : ''}
                </div>
                <div class="flex items-center gap-3 mt-1 text-sm text-slate-400">
                  <span>${formatDate(version.created_date)}</span>
                  ${version.file_size ? `<span>${version.file_size}</span>` : ''}
                </div>
                ${version.minecraft_versions?.length > 0 ? `
                  <div class="flex flex-wrap gap-1 mt-2">
                    ${version.minecraft_versions.map(v => `<span class="px-2 py-0.5 text-xs rounded border border-slate-600 text-slate-400">MC ${v}</span>`).join('')}
                  </div>
                ` : ''}
              </div>
            </div>
          `).join('')}
          ${isOwner ? `
            <div class="mt-6 text-center">
              <button onclick="showNewVersionModal('${mod.id}')" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg flex items-center gap-2 mx-auto">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                Upload New Version
              </button>
            </div>
          ` : ''}
        </div>
      `;
    }

    function renderDownloadTab(versions, mod) {
      if (versions.length === 0) {
        return `
          <div class="bg-slate-900/60 border border-slate-700/50 rounded-xl p-6">
            <p class="text-slate-400 text-center py-8">No downloads available yet</p>
          </div>
        `;
      }

      return `
        <div class="bg-slate-900/60 border border-slate-700/50 rounded-xl p-6 space-y-4">
          ${versions.map(version => `
            <div class="flex items-center justify-between p-4 bg-slate-800/50 rounded-lg border border-slate-700/50">
              <div>
                <div class="flex items-center gap-2">
                  <span class="font-semibold text-white">v${version.version_number}</span>
                  ${version.is_latest ? '<span class="px-2 py-0.5 text-xs rounded-md bg-emerald-500/20 text-emerald-300 border border-emerald-500/30">Latest</span>' : ''}
                </div>
                <div class="flex items-center gap-3 mt-1 text-sm text-slate-400">
                  ${version.file_size ? `<span>${version.file_size}</span>` : ''}
                  ${version.minecraft_versions?.length > 0 ? `<span>MC ${version.minecraft_versions.join(', ')}</span>` : ''}
                </div>
              </div>
              <button onclick="handleDownload('${mod.id}', '${version.id}')" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg text-white flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                Download
              </button>
            </div>
          `).join('')}
        </div>
      `;
    }

    function handleDownload(modId, versionId) {
      const mods = getStoredData(STORAGE_KEYS.MODS, []);
      const modIndex = mods.findIndex(m => m.id === modId);
      if (modIndex !== -1) {
        mods[modIndex].download_count = (mods[modIndex].download_count || 0) + 1;
        setStoredData(STORAGE_KEYS.MODS, mods);
      }

      const versions = getStoredData(STORAGE_KEYS.VERSIONS, []);
      const version = versions.find(v => v.id === versionId);

      if (version?.files?.[0]) {
        const downloadFile = version.files[0];
        if (downloadFile.download_url && downloadFile.download_url !== '#') {
          // Check if this is a data URL reference
          if (downloadFile.download_url.startsWith('dataurl://')) {
            // Extract file ID and retrieve from user profile
            const fileId = downloadFile.download_url.replace('dataurl://', '');
            const currentUser = getCurrentUser();
            if (currentUser && currentUser.files) {
              const fileData = currentUser.files.find(f => f.id === fileId);
              if (fileData && fileData.data) {
                // Create a download link for the data URL
                const link = document.createElement('a');
                link.href = fileData.data;
                link.download = fileData.originalName || 'download';
                link.click();
                showToast('Download started!', 'success');
              } else {
                showToast('File not found in your profile.', 'error');
              }
            } else {
              showToast('Could not access user file data.', 'error');
            }
          } else {
            // Regular URL download
            window.open(downloadFile.download_url, '_blank');
            showToast('Download started!', 'success');
          }
        } else {
          showToast('Download file not available yet. Please contact the mod author.', 'error');
        }
      } else {
        showToast('No download files available for this version.', 'error');
      }

      renderPage();
    }

    // Show modal for uploading new version
    function showNewVersionModal(modId) {
      const newVersionHTML = `
        <div id="newVersionModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
          <div class="bg-slate-900 border border-slate-700 rounded-xl p-6 w-full max-w-md mx-4">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold text-white">Upload New Version</h3>
              <button onclick="hideNewVersionModal()" class="text-slate-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
              </button>
            </div>

            <div class="space-y-4">
              <div>
                <label class="block text-white text-sm mb-2">Version Number *</label>
                <input type="text" id="newVersionNumber" placeholder="e.g., 1.0.1"
                  class="w-full px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-white placeholder:text-slate-500 outline-none focus:border-purple-500" />
              </div>

              <div>
                <label class="block text-white text-sm mb-2">Changelog</label>
                <textarea id="newVersionChangelog" rows="3" placeholder="What's new in this version..."
                  class="w-full px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-white placeholder:text-slate-500 outline-none focus:border-purple-500 resize-none"></textarea>
              </div>

              <div>
                <label class="block text-white mb-2">Supported Minecraft Versions</label>
                <div class="max-h-40 overflow-y-auto p-3 bg-slate-800/30 rounded-lg border border-slate-700">
                  ${ALL_MC_VERSIONS.map(v => `
                    <label class="flex items-center gap-2 cursor-pointer py-1">
                      <input type="checkbox" value="${v}" class="accent-purple-500 new-version-mc-versions" />
                      <span class="text-sm text-white">${v}</span>
                    </label>
                  `).join('')}
                </div>
              </div>

              <div>
                <label class="block text-white mb-2">Upload File</label>
                <div class="border-2 border-dashed border-slate-700 rounded-lg p-6 text-center hover:border-purple-500 transition-colors">
                  <input type="file" id="newVersionFile" class="hidden" />
                  <button type="button" onclick="document.getElementById('newVersionFile').click()" class="px-6 py-3 bg-purple-600 hover:bg-purple-500 text-white rounded-lg flex items-center gap-2 mx-auto">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    Select File
                  </button>
                  <p class="text-slate-500 text-sm mt-3">Click to browse your files</p>
                  <div id="newVersionFileName" class="text-white text-sm mt-2"></div>
                </div>
              </div>
            </div>

            <div class="flex gap-3 justify-end mt-6">
              <button onclick="hideNewVersionModal()" class="px-4 py-2 border border-slate-700 text-white rounded-lg hover:bg-slate-800">Cancel</button>
              <button onclick="createNewVersion('${modId}')" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg">Create New Version</button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', newVersionHTML);

      // Add event listener to update file name display
      document.getElementById('newVersionFile').addEventListener('change', function(e) {
        if (e.target.files[0]) {
          document.getElementById('newVersionFileName').textContent = e.target.files[0].name;
        } else {
          document.getElementById('newVersionFileName').textContent = '';
        }
      });
    }

    function hideNewVersionModal() {
      const modal = document.getElementById('newVersionModal');
      if (modal) modal.remove();
    }

    // Create new version
    async function createNewVersion(modId) {
      const versionNumber = document.getElementById('newVersionNumber').value.trim();
      const changelog = document.getElementById('newVersionChangelog').value.trim();
      const fileInput = document.getElementById('newVersionFile');
      const selectedVersions = Array.from(document.querySelectorAll('.new-version-mc-versions:checked')).map(cb => cb.value);

      // Validation
      if (!versionNumber) {
        showToast('Please enter a version number', 'error');
        return;
      }

      if (!fileInput.files[0]) {
        showToast('Please select a file to upload', 'error');
        return;
      }

      if (selectedVersions.length === 0) {
        showToast('Please select at least one Minecraft version', 'error');
        return;
      }

      // Get the mod to check if it's published yet
      const mods = getStoredData(STORAGE_KEYS.MODS, []);
      const mod = mods.find(m => m.id === modId);
      if (!mod) {
        showToast('Mod not found', 'error');
        return;
      }

      // Create the new version
      const versions = getStoredData(STORAGE_KEYS.VERSIONS, []);
      const newVersionId = generateId();

      // Convert the file to data URL
      const fileUrls = await uploadFilesAndGetUrls([fileInput.files[0]], modId, newVersionId);

      // Create new version object
      const newVersion = {
        id: newVersionId,
        mod_id: modId,
        version_number: versionNumber,
        changelog: changelog,
        minecraft_versions: selectedVersions,
        platforms: [], // Will be populated based on mod category
        files: fileUrls,
        is_latest: true, // Make this the latest version
        created_date: new Date().toISOString()
      };

      // Get mod category to determine platforms
      const modCategory = mod.category;
      if (modCategory === 'java_mod') {
        // For Java mods, we can set common platforms
        newVersion.platforms = ['forge', 'fabric', 'neoforge']; // Default for Java mods
      } else if (modCategory === 'plugin') {
        // For plugins
        newVersion.platforms = ['spigot', 'paper', 'bukkit'];
      }

      // If this is the first version and the mod is still pending review, keep it pending
      // Otherwise, make it published right away
      if (mod.status === 'pending_review' && versions.filter(v => v.mod_id === modId).length === 0) {
        // This is the first version of a pending mod, keep as pending
        // We'll still add it but the mod remains pending
      } else {
        // For new versions of published mods, or additional versions of any mod, set as latest
        // Update all other versions to not be latest
        versions.forEach(version => {
          if (version.mod_id === modId) {
            version.is_latest = false;
          }
        });
      }

      versions.push(newVersion);
      setStoredData(STORAGE_KEYS.VERSIONS, versions);

      // Close modal and refresh page
      hideNewVersionModal();

      // Show success message
      showToast(`Version ${versionNumber} uploaded successfully!`, 'success');

      // Update the detail page to show the new version
      renderPage();
    }

    // ==================== PUBLISH PAGE ====================
    function renderPublish() {
      if (!isLoggedIn()) {
        return `
          <div class="max-w-4xl mx-auto px-4 sm:px-6 py-12 text-center">
            <svg class="w-16 h-16 mx-auto text-slate-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
            <h2 class="text-2xl font-bold text-white mb-4">Sign In Required</h2>
            <p class="text-slate-400 mb-6">You need to sign in to publish mods</p>
            <button onclick="showAuthModal()" class="px-6 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg">Sign In</button>
          </div>
        `;
      }

      return `
        <div class="max-w-3xl mx-auto px-4 sm:px-6 py-8">
          <h1 class="text-3xl font-bold text-white mb-2">Publish Your Content</h1>
          <p class="text-slate-400 mb-8">Share your creation with the community</p>

          <!-- Steps -->
          <div class="flex items-center gap-4 mb-8">
            ${[1, 2, 3].map(s => `
              <div class="flex items-center gap-2 ${publishStep >= s ? 'text-purple-400' : 'text-slate-500'}">
                <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${
                  publishStep > s ? 'bg-purple-500 text-white' : 
                  publishStep === s ? 'bg-purple-500/20 border-2 border-purple-500 text-purple-300' : 
                  'bg-slate-800 text-slate-500'
                }">
                  ${publishStep > s ? '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' : s}
                </div>
                <span class="hidden sm:block text-sm">${s === 1 ? 'Details' : s === 2 ? 'Files' : 'Review'}</span>
              </div>
              ${s < 3 ? `<div class="flex-1 h-0.5 ${publishStep > s ? 'bg-purple-500' : 'bg-slate-700'}"></div>` : ''}
            `).join('')}
          </div>

          <!-- Form -->
          <div class="bg-slate-900/60 border border-slate-700/50 rounded-xl p-6">
            ${publishStep === 1 ? renderPublishStep1() : publishStep === 2 ? renderPublishStep2() : renderPublishStep3()}
          </div>
        </div>
      `;
    }

    function renderPublishStep1() {
      return `
        <div class="space-y-6">
          <div>
            <label class="block text-white mb-2">Title *</label>
            <input type="text" id="pub-title" value="${publishData.title || ''}" placeholder="My Awesome Mod" 
              class="w-full px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-white placeholder:text-slate-500 outline-none focus:border-purple-500" />
          </div>

          <div>
            <label class="block text-white mb-2">Category *</label>
            <div class="flex flex-wrap gap-2">
              ${categories.filter(c => c.value !== 'all').map(c => `
                <button type="button" onclick="selectPublishCategory('${c.value}')" 
                  class="px-4 py-2 rounded-lg border transition-all duration-200 ${
                    publishData.category === c.value 
                      ? 'bg-black text-white border-white' 
                      : 'bg-slate-800/50 text-slate-400 border-slate-700 hover:bg-slate-800 hover:text-white'
                  }">
                  ${c.label}
                </button>
              `).join('')}
            </div>
          </div>

          <div>
            <label class="block text-white mb-2">Short Description *</label>
            <textarea id="pub-short" rows="2" placeholder="A brief description..." 
              class="w-full px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-white placeholder:text-slate-500 outline-none focus:border-purple-500 resize-none">${publishData.short_description || ''}</textarea>
          </div>

          <div>
            <label class="block text-white mb-2">Full Description (Markdown supported)</label>
            <textarea id="pub-full" rows="6" placeholder="Detailed description with features..." 
              class="w-full px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-white placeholder:text-slate-500 outline-none focus:border-purple-500 resize-none">${publishData.full_description || ''}</textarea>
          </div>

          <div>
            <label class="block text-white mb-2">Tags (comma separated)</label>
            <input type="text" id="pub-tags" value="${(publishData.tags || []).join(', ')}" placeholder="adventure, magic, exploration"
              class="w-full px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-white placeholder:text-slate-500 outline-none focus:border-purple-500" />
          </div>

          <div>
            <label class="block text-white mb-2">Thumbnail / Icon</label>
            <div class="border-2 border-dashed border-slate-700 rounded-lg p-6 text-center hover:border-purple-500 transition-colors">
              <input type="file" id="pub-thumbnail" accept="image/*" class="hidden" />
              <button type="button" onclick="document.getElementById('pub-thumbnail').click()" class="px-6 py-3 bg-purple-600 hover:bg-purple-500 text-white rounded-lg flex items-center gap-2 mx-auto">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                Upload Thumbnail
              </button>
              <p class="text-slate-500 text-sm mt-3">JPG, PNG, or GIF (max 2MB)</p>
              <div id="pubThumbnailFileName" class="text-white text-sm mt-2">No file selected</div>
            </div>
          </div>

          <div class="flex justify-end pt-4">
            <button onclick="goToPublishStep(2)" class="px-6 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg flex items-center gap-2">
              Continue
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
            </button>
          </div>
        </div>
      `;
    }

    function selectPublishCategory(value) {
      publishData.category = value;
      renderPage();
    }

    function renderPublishStep2() {
      const isJavaOrPlugin = publishData.category === 'java_mod' || publishData.category === 'plugin';
      const platforms = publishData.category === 'java_mod' ? JAVA_MOD_PLATFORMS : PLUGIN_PLATFORMS;

      return `
        <div class="space-y-6">
          <div>
            <label class="block text-white mb-2">Version Number</label>
            <input type="text" id="ver-number" value="${versionData.version_number || '1.0.0'}" placeholder="1.0.0" 
              class="w-full max-w-xs px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-white placeholder:text-slate-500 outline-none focus:border-purple-500" />
          </div>

          <div>
            <label class="block text-white mb-2">Changelog</label>
            <textarea id="ver-changelog" rows="3" placeholder="What's new in this version..." 
              class="w-full px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-white placeholder:text-slate-500 outline-none focus:border-purple-500 resize-none">${versionData.changelog || 'Initial release'}</textarea>
          </div>

          <div>
            <label class="block text-white mb-2">Supported Minecraft Versions</label>
            <div class="flex flex-wrap gap-2 max-h-32 overflow-y-auto p-3 bg-slate-800/30 rounded-lg border border-slate-700">
              ${ALL_MC_VERSIONS.map(v => `
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" value="${v}" ${(versionData.minecraft_versions || []).includes(v) ? 'checked' : ''} 
                    onchange="toggleMcVersion('${v}')" class="accent-purple-500" />
                  <span class="text-sm text-white">${v}</span>
                </label>
              `).join('')}
            </div>
          </div>

          ${isJavaOrPlugin ? `
            <div>
              <label class="block text-white mb-2">${publishData.category === 'java_mod' ? 'Modding Platforms' : 'Server Platforms'}</label>
              <div class="flex flex-wrap gap-4">
                ${platforms.map(p => `
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" value="${p.value}" ${(versionData.platforms || []).includes(p.value) ? 'checked' : ''} 
                      onchange="togglePlatform('${p.value}')" class="accent-purple-500" />
                    <span class="text-white">${p.label}</span>
                  </label>
                `).join('')}
              </div>
            </div>
          ` : ''}

          <div>
            <label class="block text-white mb-2">Upload Files</label>
            <div class="border-2 border-dashed border-slate-700 rounded-lg p-6 text-center hover:border-purple-500 transition-colors">
              <input type="file" id="file-upload" multiple onchange="handleFileUpload(event)" class="hidden" />
              <button type="button" onclick="document.getElementById('file-upload').click()" class="px-6 py-3 bg-purple-600 hover:bg-purple-500 text-white rounded-lg flex items-center gap-2 mx-auto">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                Upload Files
              </button>
              <p class="text-slate-500 text-sm mt-3">Click to browse or drag and drop your files here</p>
            </div>
            ${uploadedFiles.length > 0 ? `
              <div class="mt-4 space-y-2">
                <p class="text-white text-sm font-medium">Uploaded Files:</p>
                ${uploadedFiles.map((file, index) => `
                  <div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg border border-slate-700">
                    <div class="flex items-center gap-2">
                      <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                      <span class="text-white text-sm">${file.name}</span>
                      <span class="text-slate-500 text-xs">(${formatFileSize(file.size)})</span>
                    </div>
                    <button onclick="removeUploadedFile(${index})" class="p-1 text-red-400 hover:text-red-300">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>

          <div class="flex justify-between pt-4">
            <button onclick="goToPublishStep(1)" class="px-6 py-2 border border-slate-700 text-white rounded-lg hover:bg-slate-800 flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
              Back
            </button>
            <button onclick="goToPublishStep(3)" class="px-6 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg flex items-center gap-2">
              Continue
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
            </button>
          </div>
        </div>
      `;
    }

    function handleFileUpload(event) {
      const files = Array.from(event.target.files);
      uploadedFiles = [...uploadedFiles, ...files];
      renderPage();
    }

    function removeUploadedFile(index) {
      uploadedFiles.splice(index, 1);
      renderPage();
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function renderPublishStep3() {
      return `
        <div class="space-y-6">
          <h2 class="text-xl font-semibold text-white">Review Your Submission</h2>
          
          <div class="p-4 bg-slate-800/50 rounded-lg border border-slate-700">
            <h3 class="font-semibold text-white text-lg">${publishData.title}</h3>
            <p class="text-slate-400 text-sm mt-1">${publishData.short_description}</p>
            <span class="inline-block mt-2 px-2 py-1 text-xs rounded border ${categoryStyles[publishData.category]}">${categoryLabels[publishData.category]}</span>
          </div>

          ${versionData.version_number ? `
            <div class="p-4 bg-slate-800/50 rounded-lg border border-slate-700">
              <h4 class="text-sm font-medium text-white mb-2">Version ${versionData.version_number}</h4>
              ${versionData.minecraft_versions?.length ? `<p class="text-sm text-slate-400">MC: ${versionData.minecraft_versions.join(', ')}</p>` : ''}
              ${versionData.platforms?.length ? `<p class="text-sm text-slate-400">Platforms: ${versionData.platforms.join(', ')}</p>` : ''}
              ${uploadedFiles.length > 0 ? `<p class="text-sm text-slate-400">Files: ${uploadedFiles.map(f => f.name).join(', ')}</p>` : ''}
            </div>
          ` : ''}

          <div class="p-4 bg-amber-500/10 border border-amber-500/30 rounded-lg">
            <p class="text-amber-300 text-sm">Your submission will be reviewed before being published.</p>
          </div>

          <div class="flex justify-between pt-4">
            <button onclick="goToPublishStep(2)" class="px-6 py-2 border border-slate-700 text-white rounded-lg hover:bg-slate-800 flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
              Back
            </button>
            <button onclick="submitMod()" class="px-6 py-2 bg-gradient-to-r from-purple-600 to-cyan-600 hover:from-purple-500 hover:to-cyan-500 text-white rounded-lg flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
              Submit for Review
            </button>
          </div>
        </div>
      `;
    }

    function goToPublishStep(step) {
      // Save current step data
      if (publishStep === 1) {
        publishData.title = document.getElementById('pub-title')?.value || '';
        publishData.short_description = document.getElementById('pub-short')?.value || '';
        publishData.full_description = document.getElementById('pub-full')?.value || '';
        const tagsInput = document.getElementById('pub-tags')?.value || '';
        publishData.tags = tagsInput.split(',').map(t => t.trim()).filter(t => t);

        // Handle thumbnail upload if a file was selected
        const thumbnailFileInput = document.getElementById('pub-thumbnail');
        if (thumbnailFileInput && thumbnailFileInput.files[0]) {
          publishData.thumbnailFile = thumbnailFileInput.files[0]; // Store the file for later upload
        }

        if (step === 2 && (!publishData.title || !publishData.category || !publishData.short_description)) {
          showToast('Please fill in all required fields', 'error');
          return;
        }
      } else if (publishStep === 2) {
        versionData.version_number = document.getElementById('ver-number')?.value || '1.0.0';
        versionData.changelog = document.getElementById('ver-changelog')?.value || 'Initial release';
      }

      publishStep = step;
      renderPage();

      // Add event listener for thumbnail file name display if we're on step 1
      if (step === 1 && publishStep === 1) {
        setTimeout(() => {
          const thumbnailInput = document.getElementById('pub-thumbnail');
          if (thumbnailInput) {
            thumbnailInput.addEventListener('change', function(e) {
              if (e.target.files[0]) {
                document.getElementById('pubThumbnailFileName').textContent = e.target.files[0].name;
              } else {
                document.getElementById('pubThumbnailFileName').textContent = 'No file selected';
              }
            });
          }
        }, 100); // Small delay to ensure DOM is ready
      }
    }

    function toggleMcVersion(version) {
      if (!versionData.minecraft_versions) versionData.minecraft_versions = [];
      const index = versionData.minecraft_versions.indexOf(version);
      if (index === -1) {
        versionData.minecraft_versions.push(version);
      } else {
        versionData.minecraft_versions.splice(index, 1);
      }
    }

    function togglePlatform(platform) {
      if (!versionData.platforms) versionData.platforms = [];
      const index = versionData.platforms.indexOf(platform);
      if (index === -1) {
        versionData.platforms.push(platform);
      } else {
        versionData.platforms.splice(index, 1);
      }
    }

    async function submitMod() {
      const user = getCurrentUser();
      const mods = getStoredData(STORAGE_KEYS.MODS, []);

      // Handle thumbnail upload if provided
      let thumbnailUrl = '';
      if (publishData.thumbnailFile) {
        // Convert the thumbnail to data URL
        const thumbnailFile = publishData.thumbnailFile;

        // Validate file type
        if (!thumbnailFile.type.match('image.*')) {
          showToast('Please select an image file for thumbnail (JPEG, PNG, GIF)', 'error');
          return;
        }

        // Validate file size (max 2MB)
        if (thumbnailFile.size > 2 * 1024 * 1024) {
          showToast('Thumbnail file size must be under 2MB', 'error');
          return;
        }

        try {
          // Convert thumbnail to data URL
          const dataUrl = await fileToDataUrl(thumbnailFile);

          // Store thumbnail data in the user's profile data for cross-device sync
          const currentUser = getCurrentUser();
          if (currentUser) {
            // Initialize user files array if it doesn't exist
            if (!currentUser.files) {
              currentUser.files = [];
            }

            // Create a unique ID for this thumbnail
            const fileId = generateId();
            const fileName = `thumbnail_${modId}_${Date.now()}.jpg`; // Use jpg for thumbnails

            // Add thumbnail data to user profile
            currentUser.files.push({
              id: fileId,
              name: fileName,
              data: dataUrl, // Store the actual data URL
              modId: modId,
              originalName: thumbnailFile.name,
              uploadDate: new Date().toISOString(),
              type: 'thumbnail'
            });

            // Update the current user in localStorage
            const isAdmin = getStoredData(STORAGE_KEYS.IS_ADMIN, false);
            setStoredData(STORAGE_KEYS.IS_ADMIN, isAdmin); // Ensure admin status is preserved
            setStoredData(STORAGE_KEYS.CURRENT_USER, currentUser);

            // Update the users list to persist on other devices
            const allUsers = getStoredData(STORAGE_KEYS.USERS, []);
            const userIndex = allUsers.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
              // Preserve admin status when updating user data
              allUsers[userIndex] = {
                ...currentUser,
                is_admin: allUsers[userIndex].is_admin // Preserve existing admin status
              };
              setStoredData(STORAGE_KEYS.USERS, allUsers);
            }

            // Create a download URL that references the thumbnail in user profile
            thumbnailUrl = `dataurl://${fileId}`;
          } else {
            // Fallback to direct data URL if no user
            thumbnailUrl = dataUrl;
          }

          showToast('Thumbnail uploaded successfully!', 'success');
        } catch (error) {
          console.error('Error converting thumbnail to data URL:', error);
          showToast('Error with thumbnail. Mod will be submitted without thumbnail.', 'error');
          // Continue with empty thumbnail URL
        }
      }

      const newModId = generateId();
      const newMod = {
        id: newModId,
        ...publishData,
        thumbnail_url: thumbnailUrl,
        screenshots: [],
        download_count: 0,
        author_name: user.full_name || 'Anonymous',
        author_id: user.id,
        status: 'pending_review',
        created_date: new Date().toISOString()
      };

      // Remove the thumbnailFile property since it's not needed in the stored data
      delete newMod.thumbnailFile;

      mods.push(newMod);
      setStoredData(STORAGE_KEYS.MODS, mods);

      // Create version if provided
      if (versionData.version_number) {
        const versions = getStoredData(STORAGE_KEYS.VERSIONS, []);
        const newVersionId = generateId();

        // Upload files to Firebase Storage and get actual download URLs
        const fileUrls = await uploadFilesAndGetUrls(uploadedFiles, newModId, newVersionId);

        versions.push({
          id: newVersionId,
          mod_id: newModId,
          ...versionData,
          files: fileUrls,
          is_latest: true,
          created_date: new Date().toISOString()
        });
        setStoredData(STORAGE_KEYS.VERSIONS, versions);
      }

      // Reset form
      publishData = {};
      versionData = {};
      publishStep = 1;
      uploadedFiles = [];

      showToast('Submitted for review!', 'success');
      navigateTo('myMods');
    }

    // ==================== MY MODS PAGE ====================
    function renderMyMods() {
      if (!isLoggedIn()) {
        return `
          <div class="max-w-4xl mx-auto px-4 sm:px-6 py-12 text-center">
            <svg class="w-16 h-16 mx-auto text-slate-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
            <h2 class="text-2xl font-bold text-white mb-4">Sign In Required</h2>
            <p class="text-slate-400 mb-6">You need to sign in to view your mods</p>
            <button onclick="showAuthModal()" class="px-6 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg">Sign In</button>
          </div>
        `;
      }

      const user = getCurrentUser();
      const mods = getStoredData(STORAGE_KEYS.MODS, []).filter(m => m.author_id === user.id);
      const versions = getStoredData(STORAGE_KEYS.VERSIONS, []);

      const statusStyles = {
        draft: 'bg-slate-500/20 text-slate-300 border-slate-500/30',
        pending_review: 'bg-amber-500/20 text-amber-300 border-amber-500/30',
        published: 'bg-emerald-500/20 text-emerald-300 border-emerald-500/30',
        archived: 'bg-red-500/20 text-red-300 border-red-500/30'
      };

      return `
        <div class="max-w-5xl mx-auto px-4 sm:px-6 py-8">
          <div class="flex items-center justify-between mb-8">
            <div>
              <h1 class="text-3xl font-bold text-white">My Mods</h1>
              <p class="text-slate-400 mt-1">Manage your published content</p>
            </div>
            <button onclick="navigateTo('publish')" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
              New
            </button>
          </div>

          ${mods.length === 0 ? `
            <div class="bg-slate-900/60 border border-slate-700/50 rounded-xl p-12 text-center">
              <svg class="w-16 h-16 mx-auto text-slate-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
              <h3 class="text-xl font-medium text-white mb-2">No mods yet</h3>
              <p class="text-slate-400 mb-6">Start sharing your creations</p>
              <button onclick="navigateTo('publish')" class="px-6 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg">
                Publish Your First Mod
              </button>
            </div>
          ` : `
            <div class="space-y-4">
              ${mods.map(mod => {
                const modVersions = versions.filter(v => v.mod_id === mod.id);
                return `
                  <div class="bg-slate-900/60 border border-slate-700/50 rounded-xl p-4 hover:border-slate-600 transition-colors">
                    <div class="flex items-start gap-4">
                      ${mod.thumbnail_url
                        ? getThumbnailSrcForSize(mod.thumbnail_url, '20', '14')
                        : `<div class="w-20 h-14 rounded-lg flex-shrink-0 bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center"><span class="text-white font-bold text-xs text-center px-1">${mod.title}</span></div>`
                      }
                      <div class="flex-1 min-w-0">
                        <div class="flex items-start justify-between gap-4">
                          <div>
                            <h3 class="font-semibold text-white">${mod.title}</h3>
                            <p class="text-slate-400 text-sm line-clamp-1">${mod.short_description}</p>
                          </div>
                          <div class="flex items-center gap-2">
                            <span class="px-2 py-1 text-xs rounded border ${statusStyles[mod.status]}">${mod.status === 'pending_review' ? 'Pending' : mod.status}</span>
                            <div class="relative" id="menu-${mod.id}">
                              <button onclick="toggleModMenu('${mod.id}')" class="p-2 text-slate-400 hover:bg-slate-800 rounded-lg">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path></svg>
                              </button>
                              <div id="dropdown-${mod.id}" class="hide absolute right-0 mt-1 w-40 bg-slate-900 border border-slate-700 rounded-lg shadow-xl py-1 z-10">
                                <button onclick="navigateTo('detail', { modId: '${mod.id}' })" class="w-full text-left px-3 py-2 text-slate-300 hover:bg-slate-800 flex items-center gap-2 text-sm">
                                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                  View
                                </button>
                                <button onclick="navigateTo('edit', { modId: '${mod.id}' })" class="w-full text-left px-3 py-2 text-slate-300 hover:bg-slate-800 flex items-center gap-2 text-sm">
                                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                  Edit
                                </button>
                                <button onclick="deleteMod('${mod.id}')" class="w-full text-left px-3 py-2 text-red-400 hover:bg-slate-800 flex items-center gap-2 text-sm">
                                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                  Delete
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="flex items-center gap-4 mt-3 text-sm text-slate-500">
                          <span>${categoryLabels[mod.category]}</span>
                          <span class="flex items-center gap-1">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            ${(mod.download_count || 0).toLocaleString()}
                          </span>
                          <span>${modVersions.length} versions</span>
                          <span>${formatDate(mod.created_date)}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `}
        </div>
      `;
    }

    function toggleModMenu(modId) {
      // Close all other menus
      document.querySelectorAll('[id^="dropdown-"]').forEach(el => el.classList.add('hide'));
      document.getElementById(`dropdown-${modId}`).classList.toggle('hide');
    }

    function deleteMod(modId) {
      if (!confirm('Are you sure you want to delete this mod?')) return;
      
      let mods = getStoredData(STORAGE_KEYS.MODS, []);
      mods = mods.filter(m => m.id !== modId);
      setStoredData(STORAGE_KEYS.MODS, mods);

      let versions = getStoredData(STORAGE_KEYS.VERSIONS, []);
      versions = versions.filter(v => v.mod_id !== modId);
      setStoredData(STORAGE_KEYS.VERSIONS, versions);

      showToast('Mod deleted', 'success');
      renderPage();
    }

    // ==================== EDIT MOD PAGE ====================
    function renderEditMod() {
      const mods = getStoredData(STORAGE_KEYS.MODS, []);
      const mod = mods.find(m => m.id === currentModId);

      if (!mod) {
        return `
          <div class="max-w-4xl mx-auto px-4 sm:px-6 py-12 text-center">
            <h2 class="text-2xl font-bold text-white mb-4">Mod not found</h2>
            <button onclick="navigateTo('myMods')" class="px-4 py-2 border border-slate-700 text-slate-300 rounded-lg hover:bg-slate-800">‚Üê Back to My Mods</button>
          </div>
        `;
      }

      return `
        <div class="max-w-3xl mx-auto px-4 sm:px-6 py-8">
          <button onclick="navigateTo('myMods')" class="inline-flex items-center text-slate-300 hover:text-white mb-6 transition-colors">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            Back to My Mods
          </button>

          <h1 class="text-3xl font-bold text-white mb-2">Edit Mod</h1>
          <p class="text-slate-400 mb-8">Update your content</p>

          <div class="bg-slate-900/60 border border-slate-700/50 rounded-xl p-6 space-y-6">
            <div>
              <label class="block text-white mb-2">Title *</label>
              <input type="text" id="edit-title" value="${mod.title}"
                class="w-full px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-white placeholder:text-slate-500 outline-none focus:border-purple-500" />
            </div>

            <div>
              <label class="block text-white mb-2">Category *</label>
              <select id="edit-category" class="w-full px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-white outline-none focus:border-purple-500">
                ${categories.filter(c => c.value !== 'all').map(c => `
                  <option value="${c.value}" ${mod.category === c.value ? 'selected' : ''}>${c.label}</option>
                `).join('')}
              </select>
            </div>

            <div>
              <label class="block text-white mb-2">Short Description *</label>
              <textarea id="edit-short" rows="2"
                class="w-full px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-white placeholder:text-slate-500 outline-none focus:border-purple-500 resize-none">${mod.short_description}</textarea>
            </div>

            <div>
              <label class="block text-white mb-2">Full Description</label>
              <textarea id="edit-full" rows="6"
                class="w-full px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-white placeholder:text-slate-500 outline-none focus:border-purple-500 resize-none">${mod.full_description || ''}</textarea>
            </div>

            <div>
              <label class="block text-white mb-2">Tags (comma separated)</label>
              <input type="text" id="edit-tags" value="${(mod.tags || []).join(', ')}"
                class="w-full px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-white placeholder:text-slate-500 outline-none focus:border-purple-500" />
            </div>

            <div>
              <label class="block text-white mb-2">Thumbnail</label>
              <div class="flex items-start gap-4">
                <div class="flex-shrink-0">
                  ${mod.thumbnail_url
                    ? getThumbnailSrcForSize(mod.thumbnail_url, '16', '16')
                    : `<div class="w-16 h-16 rounded-lg bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center"><span class="text-white text-xs">${mod.title.substring(0, 2)}</span></div>`
                  }
                </div>
                <div class="flex-1">
                  <div class="border-2 border-dashed border-slate-700 rounded-lg p-4 text-center hover:border-purple-500 transition-colors">
                    <input type="file" id="edit-thumbnail" accept="image/*" class="hidden" />
                    <button type="button" onclick="document.getElementById('edit-thumbnail').click()" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg text-sm">
                      ${mod.thumbnail_url ? 'Change Thumbnail' : 'Upload Thumbnail'}
                    </button>
                    <p class="text-slate-500 text-xs mt-2">JPG, PNG, or GIF (max 2MB)</p>
                    <div id="editThumbnailFileName" class="text-white text-xs mt-1">${mod.thumbnail_url ? 'Current file selected' : 'No file selected'}</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="flex justify-between gap-3 pt-4 border-t border-slate-700/50">
              <button onclick="deleteModFromEdit('${mod.id}')" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                Delete Project
              </button>
              <div class="flex gap-3">
                <button onclick="navigateTo('myMods')" class="px-4 py-2 border border-slate-700 text-white rounded-lg hover:bg-slate-800">Cancel</button>
                <button onclick="saveMod('${mod.id}')" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                  Save Changes
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function deleteModFromEdit(modId) {
      if (!confirm('Are you sure you want to delete this project? This action cannot be undone.')) return;
      
      let mods = getStoredData(STORAGE_KEYS.MODS, []);
      mods = mods.filter(m => m.id !== modId);
      setStoredData(STORAGE_KEYS.MODS, mods);

      let versions = getStoredData(STORAGE_KEYS.VERSIONS, []);
      versions = versions.filter(v => v.mod_id !== modId);
      setStoredData(STORAGE_KEYS.VERSIONS, versions);

      showToast('Project deleted successfully', 'success');
      navigateTo('myMods');
    }

    async function saveMod(modId) {
      const mods = getStoredData(STORAGE_KEYS.MODS, []);
      const modIndex = mods.findIndex(m => m.id === modId);

      if (modIndex !== -1) {
        const tagsInput = document.getElementById('edit-tags')?.value || '';

        // Handle thumbnail upload if a new file is selected
        let thumbnailUrl = mods[modIndex].thumbnail_url; // Keep existing thumbnail by default
        const thumbnailFileInput = document.getElementById('edit-thumbnail');

        if (thumbnailFileInput && thumbnailFileInput.files[0]) {
          // Convert the new thumbnail to data URL
          const thumbnailFile = thumbnailFileInput.files[0];

          // Validate file type
          if (!thumbnailFile.type.match('image.*')) {
            showToast('Please select an image file (JPEG, PNG, GIF)', 'error');
            return;
          }

          // Validate file size (max 2MB)
          if (thumbnailFile.size > 2 * 1024 * 1024) {
            showToast('Thumbnail file size must be under 2MB', 'error');
            return;
          }

          try {
            // Convert thumbnail to data URL
            const dataUrl = await fileToDataUrl(thumbnailFile);

            // Store thumbnail data in the user's profile data for cross-device sync
            const currentUser = getCurrentUser();
            if (currentUser) {
              // Initialize user files array if it doesn't exist
              if (!currentUser.files) {
                currentUser.files = [];
              }

              // Create a unique ID for this thumbnail
              const fileId = generateId();
              const fileName = `thumbnail_${modId}_${Date.now()}.jpg`; // Use jpg for thumbnails

              // Add thumbnail data to user profile
              currentUser.files.push({
                id: fileId,
                name: fileName,
                data: dataUrl, // Store the actual data URL
                modId: modId,
                originalName: thumbnailFile.name,
                uploadDate: new Date().toISOString(),
                type: 'thumbnail'
              });

              // Update the current user in localStorage
              const isAdmin = getStoredData(STORAGE_KEYS.IS_ADMIN, false);
              setStoredData(STORAGE_KEYS.IS_ADMIN, isAdmin); // Ensure admin status is preserved
              setStoredData(STORAGE_KEYS.CURRENT_USER, currentUser);

              // Update the users list to persist on other devices
              const allUsers = getStoredData(STORAGE_KEYS.USERS, []);
              const userIndex = allUsers.findIndex(u => u.id === currentUser.id);
              if (userIndex !== -1) {
                // Preserve admin status when updating user data
                allUsers[userIndex] = {
                  ...currentUser,
                  is_admin: allUsers[userIndex].is_admin // Preserve existing admin status
                };
                setStoredData(STORAGE_KEYS.USERS, allUsers);
              }

              // Create a download URL that references the thumbnail in user profile
              thumbnailUrl = `dataurl://${fileId}`;
            } else {
              // Fallback to direct data URL if no user
              thumbnailUrl = dataUrl;
            }

            showToast('Thumbnail uploaded successfully!', 'success');
          } catch (error) {
            console.error('Error converting thumbnail to data URL:', error);
            showToast('Error with thumbnail. Using existing thumbnail.', 'error');
            // Keep the existing thumbnail URL
          }
        }

        // Update the mod with new data
        mods[modIndex] = {
          ...mods[modIndex],
          title: document.getElementById('edit-title')?.value || '',
          category: document.getElementById('edit-category')?.value || '',
          short_description: document.getElementById('edit-short')?.value || '',
          full_description: document.getElementById('edit-full')?.value || '',
          tags: tagsInput.split(',').map(t => t.trim()).filter(t => t),
          thumbnail_url: thumbnailUrl // Update with potentially new thumbnail URL
        };

        setStoredData(STORAGE_KEYS.MODS, mods);
        showToast('Saved successfully!', 'success');
        navigateTo('myMods');
      }
    }

    // ==================== PROFILE PAGE ====================
    function renderProfile() {
      if (!isLoggedIn()) {
        return `
          <div class="max-w-4xl mx-auto px-4 sm:px-6 py-12 text-center">
            <svg class="w-16 h-16 mx-auto text-slate-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
            <h2 class="text-2xl font-bold text-white mb-4">Sign In Required</h2>
            <p class="text-slate-400 mb-6">You need to sign in to view your profile</p>
            <button onclick="showAuthModal()" class="px-6 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg">Sign In</button>
          </div>
        `;
      }

      const user = getCurrentUser();
      const mods = getStoredData(STORAGE_KEYS.MODS, []).filter(m => m.author_id === user.id);
      const totalDownloads = mods.reduce((sum, m) => sum + (m.download_count || 0), 0);
      const isAdmin = getStoredData(STORAGE_KEYS.IS_ADMIN, false);

      return `
        <div class="max-w-4xl mx-auto px-4 sm:px-6 py-8">
          <h1 class="text-3xl font-bold text-white mb-2">Profile</h1>
          <p class="text-slate-400 mb-8">Manage your profile settings</p>

          <div class="bg-slate-900/60 border border-slate-700/50 rounded-xl p-6 space-y-6">
            <div>
              <label class="block text-white mb-2">Email</label>
              <input type="email" value="${user.email || ''}" disabled 
                class="w-full px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-white opacity-60" />
            </div>

            <div>
              <label class="block text-white mb-2">Display Name</label>
              <input type="text" id="profile-name" value="${user.full_name || ''}" placeholder="Your display name" 
                class="w-full px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-white placeholder:text-slate-500 outline-none focus:border-purple-500" />
            </div>

            <div>
              <label class="block text-white mb-2">PayPal Link</label>
              <input type="url" id="profile-paypal" value="${user.paypal_link || ''}" placeholder="https://paypal.me/yourusername" 
                class="w-full px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-white placeholder:text-slate-500 outline-none focus:border-purple-500" />
              <p class="text-slate-500 text-xs mt-1">Add your PayPal link so users can support you</p>
            </div>

            <div>
              <label class="block text-white mb-2">Discord Invite Link</label>
              <input type="url" id="profile-discord" value="${user.discord_link || ''}" placeholder="https://discord.gg/yourinvite" 
                class="w-full px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-white placeholder:text-slate-500 outline-none focus:border-purple-500" />
            </div>

            ${isAdmin ? `
              <div class="border-t border-slate-700/50 pt-6">
                <div class="flex items-center gap-2 p-3 bg-emerald-500/10 border border-emerald-500/30 rounded-lg">
                  <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                  <span class="text-emerald-300">Admin access is active</span>
                  <button onclick="revokeAdmin()" class="ml-auto text-sm text-red-400 hover:text-red-300">Revoke</button>
                </div>
              </div>
            ` : ''}

            <div class="border-t border-slate-700/50 pt-6">
              <h3 class="text-lg font-semibold text-white mb-4">Statistics</h3>
              <div class="grid grid-cols-2 gap-4">
                <div class="p-4 bg-slate-800/50 rounded-lg">
                  <p class="text-2xl font-bold text-white">${mods.length}</p>
                  <p class="text-slate-400 text-sm">Published Mods</p>
                </div>
                <div class="p-4 bg-slate-800/50 rounded-lg">
                  <p class="text-2xl font-bold text-white">${totalDownloads.toLocaleString()}</p>
                  <p class="text-slate-400 text-sm">Total Downloads</p>
                </div>
              </div>

              <div class="border-t border-slate-700/50 pt-6">
                <h3 class="text-lg font-semibold text-white mb-4">Account Data Management</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <button onclick="backupAccountData()" class="px-4 py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg">
                    <svg class="w-5 h-5 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    Export Data
                  </button>
                  <button onclick="restoreAccountData()" class="px-4 py-3 bg-amber-600 hover:bg-amber-500 text-white rounded-lg">
                    <svg class="w-5 h-5 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path></svg>
                    Import Data
                  </button>
                  <button onclick="showDataBackupInstructions()" class="px-4 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg">
                    <svg class="w-5 h-5 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    How To Backup
                  </button>
                </div>
              </div>
            </div>


            <div class="flex justify-end pt-4 border-t border-slate-700/50">
              <button onclick="saveProfile()" class="px-6 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                Save Profile
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function saveProfile() {
      const user = getCurrentUser();
      // Preserve important data like admin status
      const isAdmin = user.is_admin;

      user.full_name = document.getElementById('profile-name')?.value || '';
      user.paypal_link = document.getElementById('profile-paypal')?.value || '';
      user.discord_link = document.getElementById('profile-discord')?.value || '';

      // Update in current user
      setStoredData(STORAGE_KEYS.CURRENT_USER, user);

      // Update in users list
      const users = getStoredData(STORAGE_KEYS.USERS, []);
      const userIndex = users.findIndex(u => u.id === user.id);
      if (userIndex !== -1) {
        // Preserve admin status and other important properties when updating
        users[userIndex] = {
          ...users[userIndex], // Keep existing data
          ...user, // Update with new profile data
          is_admin: isAdmin // Preserve admin status
        };
        setStoredData(STORAGE_KEYS.USERS, users);
      }

      document.getElementById('userEmail').textContent = user.full_name || user.email || 'Guest';
      showToast('Profile saved!', 'success');
      syncDataToStorage(); // Trigger sync immediately
    }

    function revokeAdmin() {
      setStoredData(STORAGE_KEYS.IS_ADMIN, false);
      showToast('Admin access revoked', 'success');
      updateAdminUI();
      renderPage();
      syncDataToStorage();
    }


    // ==================== REVIEW QUEUE PAGE ====================
    function renderReviewQueue() {
      const isAdmin = getStoredData(STORAGE_KEYS.IS_ADMIN, false);
      
      if (!isAdmin) {
        return `
          <div class="max-w-4xl mx-auto px-4 sm:px-6 py-12 text-center">
            <svg class="w-16 h-16 mx-auto text-slate-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
            <h2 class="text-2xl font-bold text-white mb-4">Admin Access Required</h2>
            <p class="text-slate-400 mb-6">You need admin access to view the review queue. Sign in with an admin code to access this page.</p>
            <button onclick="handleLogout(); showAuthModal();" class="px-6 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg">Sign In as Admin</button>
          </div>
        `;
      }

      const allMods = getStoredData(STORAGE_KEYS.MODS, []);
      const pendingMods = allMods.filter(m => m.status === 'pending_review');

      return `
        <div class="max-w-5xl mx-auto px-4 sm:px-6 py-8">
          <div class="flex items-center gap-3 mb-8">
            <svg class="w-8 h-8 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
            <div>
              <h1 class="text-3xl font-bold text-white">Review Queue</h1>
              <p class="text-slate-400 mt-1">Review and approve submitted content</p>
            </div>
          </div>

          ${pendingMods.length === 0 ? `
            <div class="bg-slate-900/60 border border-slate-700/50 rounded-xl p-12 text-center">
              <svg class="w-16 h-16 mx-auto text-slate-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
              <h3 class="text-xl font-medium text-white mb-2">No pending reviews</h3>
              <p class="text-slate-400">All submissions have been reviewed</p>
            </div>
          ` : `
            <div class="space-y-4">
              ${pendingMods.map(mod => `
                <div class="bg-slate-900/60 border border-slate-700/50 rounded-xl p-4 hover:border-slate-600 transition-colors">
                  <div class="flex items-start gap-4">
                    ${mod.thumbnail_url
                      ? getThumbnailSrcForSize(mod.thumbnail_url, '24', '16')
                      : `<div class="w-24 h-16 rounded-lg flex-shrink-0 bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center"><span class="text-white font-bold text-xs text-center px-1">${mod.title}</span></div>`
                    }
                    <div class="flex-1 min-w-0">
                      <div class="flex items-start justify-between gap-4">
                        <div>
                          <h3 class="font-semibold text-white">${mod.title}</h3>
                          <p class="text-slate-400 text-sm line-clamp-1">${mod.short_description}</p>
                          <div class="flex items-center gap-3 mt-2 text-sm text-slate-500">
                            <span class="px-2 py-0.5 text-xs rounded border ${categoryStyles[mod.category]}">${categoryLabels[mod.category]}</span>
                            <span>by ${mod.author_name}</span>
                            <span>${formatDate(mod.created_date)}</span>
                          </div>
                        </div>
                        <div class="flex items-center gap-2">
                          <button onclick="navigateTo('detail', { modId: '${mod.id}' })" class="px-3 py-1.5 border border-slate-700 text-slate-300 rounded-lg hover:bg-slate-800 flex items-center gap-1 text-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                            View
                          </button>
                          <button onclick="approveMod('${mod.id}')" class="px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg flex items-center gap-1 text-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            Approve
                          </button>
                          <button onclick="rejectMod('${mod.id}')" class="px-3 py-1.5 bg-red-600 hover:bg-red-500 text-white rounded-lg flex items-center gap-1 text-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            Reject
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          `}
        </div>
      `;
    }

    function approveMod(modId) {
      const mods = getStoredData(STORAGE_KEYS.MODS, []);
      const modIndex = mods.findIndex(m => m.id === modId);
      if (modIndex !== -1) {
        mods[modIndex].status = 'published';
        setStoredData(STORAGE_KEYS.MODS, mods);
        showToast('Mod approved and published!', 'success');
        renderPage();
      }
    }

    function rejectMod(modId) {
      const mods = getStoredData(STORAGE_KEYS.MODS, []);
      const modIndex = mods.findIndex(m => m.id === modId);
      if (modIndex !== -1) {
        mods[modIndex].status = 'archived';
        setStoredData(STORAGE_KEYS.MODS, mods);
        showToast('Mod rejected', 'success');
        renderPage();
      }
    }

    // ==================== INITIALIZE ====================
    document.addEventListener('DOMContentLoaded', () => {
      initializeData();
      if (isLoggedIn()) {
        startAutoSync();
      }
      updateAuthUI();
      renderPage();
    });

    // Close menus when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('[id^="menu-"]')) {
        document.querySelectorAll('[id^="dropdown-"]').forEach(el => el.classList.add('hide'));
      }
    });

    // ==================== CODE IDE PAGES ====================
    function renderCodeIDE() {
      return '<div class="max-w-7xl mx-auto px-4 sm:px-6 py-8">' +
          '<div class="bg-slate-900 border border-slate-700 rounded-xl min-h-[70vh]">' +
            '<!-- Project Management Section -->' +
            '<div class="border-b border-slate-700 p-6 flex flex-wrap items-center justify-between gap-4">' +
              '<div>' +
                '<h1 class="text-2xl font-bold text-white">Code IDE</h1>' +
                '<p class="text-slate-400">Create, edit, and manage your projects</p>' +
              '</div>' +

              '<div class="flex gap-3">' +
                '<button onclick="newProject()" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg flex items-center gap-2">' +
                  '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>' +
                  'New Project' +
                '</button>' +
                '<button onclick="loadProject()" class="px-4 py-2 border border-slate-600 text-slate-300 hover:bg-slate-800 rounded-lg flex items-center gap-2">' +
                  '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>' +
                  'Load Project' +
                '</button>' +
                '<button onclick="importProject()" class="px-4 py-2 border border-slate-600 text-slate-300 hover:bg-slate-800 rounded-lg flex items-center gap-2">' +
                  '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path></svg>' +
                  'Import Project' +
                '</button>' +
              '</div>' +
            '</div>' +

            '<!-- Project Directory Section -->' +
            '<div class="p-6" id="codeIDEContent">' +
              '<div class="text-center py-20">' +
                '<h3 class="text-xl font-semibold text-slate-300 mb-2">No Project Open</h3>' +
                '<p class="text-slate-500 mb-6">Start a new project or load an existing one</p>' +
                '<div class="flex justify-center gap-3">' +
                  '<button onclick="newProject()" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg">' +
                    'Create New Project' +
                  '</button>' +
                  '<button onclick="loadProject()" class="px-4 py-2 border border-slate-600 text-slate-300 hover:bg-slate-800 rounded-lg">' +
                    'Load Project' +
                  '</button>' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>';
    }

    // Project Management Functions
    function newProject() {
      // Show project creation interface
      const content = document.getElementById('codeIDEContent');
      content.innerHTML =
        '<div class="flex flex-col items-center justify-center py-20">' +
          '<div class="bg-slate-800 border border-slate-700 rounded-xl p-8 w-full max-w-md">' +
            '<h3 class="text-xl font-bold text-white mb-6 text-center">New Project</h3>' +

            '<div class="space-y-4">' +
              '<div>' +
                '<label class="block text-white text-sm mb-2">Project Name</label>' +
                '<input type="text" id="projectName" placeholder="Enter project name" ' +
                  'class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder:text-slate-500 outline-none focus:border-purple-500" />' +
              '</div>' +

              '<div class="flex justify-end gap-3 pt-4">' +
                '<button onclick="showProjectManagement()" class="px-4 py-2 border border-slate-600 text-slate-300 hover:bg-slate-700 rounded-lg">' +
                  'Cancel' +
                '</button>' +
                '<button onclick="createProject()" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg">' +
                  'Create Project' +
                '</button>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>';
    }

    function loadProject() {
      // Show project loading interface
      const content = document.getElementById('codeIDEContent');
      content.innerHTML =
        '<div class="flex flex-col items-center justify-center py-20">' +
          '<div class="bg-slate-800 border border-slate-700 rounded-xl p-8 w-full max-w-md">' +
            '<h3 class="text-xl font-bold text-white mb-6 text-center">Load Project</h3>' +

            '<div class="space-y-4">' +
              '<div>' +
                '<label class="block text-white text-sm mb-2">Select Project</label>' +
                '<select id="projectList" ' +
                  'class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white outline-none focus:border-purple-500">' +
                  '<option value="">-- Loading projects... --</option>' +
                '</select>' +
              '</div>' +

              '<div class="flex justify-end gap-3 pt-4">' +
                '<button onclick="showProjectManagement()" class="px-4 py-2 border border-slate-600 text-slate-300 hover:bg-slate-700 rounded-lg">' +
                  'Cancel' +
                '</button>' +
                '<button onclick="loadSelectedProject()" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg">' +
                  'Load Project' +
                '</button>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>';

      // Populate project list from localStorage and Firebase
      setTimeout(populateProjectList, 100); // Delay to allow DOM to update first
    }

    function populateProjectList() {
      const projectList = document.getElementById('projectList');
      projectList.innerHTML = '<option value="">-- Select a project --</option>';

      try {
        // First, add projects from localStorage
        const savedProjects = JSON.parse(localStorage.getItem('savedProjects') || '{}');
        for (const projectName in savedProjects) {
          const option = document.createElement('option');
          option.value = projectName;
          option.textContent = projectName;
          projectList.appendChild(option);
        }

        // If Firebase is available, also get projects from Firebase Storage
        if (typeof firebase !== 'undefined' && storage) {
          const projectsRef = storage.ref('projects/');

          projectsRef.listAll()
            .then((result) => {
              result.items.forEach((itemRef) => {
                // Only add projects not already in localStorage
                const projectName = itemRef.name.replace('.json', '');
                if (!savedProjects[projectName]) {
                  const option = document.createElement('option');
                  option.value = projectName;
                  option.textContent = projectName + ' (cloud)';
                  projectList.appendChild(option);
                }
              });
            })
            .catch((error) => {
              console.error("Error listing projects from Firebase:", error);
              // Still show projects from localStorage even if Firebase fails
            });
        }
      } catch (error) {
        console.error("Error populating project list:", error);
        projectList.innerHTML = '<option value="">-- Error loading projects --</option>';
      }
    }

    function importProject() {
      // Show project import interface
      const content = document.getElementById('codeIDEContent');
      content.innerHTML =
        '<div class="flex flex-col items-center justify-center py-20">' +
          '<div class="bg-slate-800 border border-slate-700 rounded-xl p-8 w-full max-w-md">' +
            '<h3 class="text-xl font-bold text-white mb-6 text-center">Import Project</h3>' +

            '<div class="space-y-4">' +
              '<div>' +
                '<label class="block text-white text-sm mb-2">Import Type</label>' +
                '<div class="flex gap-2 mb-4">' +
                  '<button id="importTypeFile" onclick="setImportType(\'file\')" class="flex-1 px-3 py-2 border border-slate-600 text-slate-300 rounded-lg hover:bg-slate-700">File</button>' +
                  '<button id="importTypeFolder" onclick="setImportType(\'folder\')" class="flex-1 px-3 py-2 border border-slate-600 text-slate-300 rounded-lg hover:bg-slate-700">Folder</button>' +
                '</div>' +
              '</div>' +

              '<div>' +
                '<label class="block text-white text-sm mb-2">Select File/Folder</label>' +
                '<input type="file" id="importFile" placeholder="Select file or folder" ' +
                  'class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder:text-slate-500 outline-none focus:border-purple-500" ' +
                  'webkitdirectory multiple />' +
              '</div>' +

              '<div class="flex justify-end gap-3 pt-4">' +
                '<button onclick="showProjectManagement()" class="px-4 py-2 border border-slate-600 text-slate-300 hover:bg-slate-700 rounded-lg">' +
                  'Cancel' +
                '</button>' +
                '<button onclick="importSelectedProject()" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg">' +
                  'Import Project' +
                '</button>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>';
    }

    // Project State Variables
    let currentProject = null;
    let projectFiles = {};
    let currentFile = null;
    let deleteMode = false;

    function createProject() {
      const projectName = document.getElementById('projectName').value.trim();
      if (!projectName) {
        showToast('Please enter a project name', 'error');
        return;
      }

      currentProject = {
        name: projectName,
        type: 'custom', // Default to custom since we removed the type selection
        created: new Date().toISOString(),
        files: {}
      };

      initializeProjectIDE();
      showToast('Project \'' + projectName + '\' created successfully!', 'success');
    }

    function loadSelectedProject() {
      const selectedProject = document.getElementById('projectList').value;
      if (!selectedProject) {
        showToast('Please select a project to load', 'error');
        return;
      }

      try {
        // First, try to load from localStorage
        const savedProjects = JSON.parse(localStorage.getItem('savedProjects') || '{}');
        if (savedProjects[selectedProject]) {
          currentProject = savedProjects[selectedProject];
          initializeProjectIDE();
          showToast('Project \'' + selectedProject + '\' loaded from local storage!', 'success');
          return;
        }

        // If not found locally, try to load from Firebase Storage
        if (typeof firebase !== 'undefined' && storage) {
          const projectRef = storage.ref('projects/' + selectedProject + '.json');

          projectRef.getDownloadURL()
            .then((url) => {
              return fetch(url);
            })
            .then(response => response.json())
            .then((projectData) => {
              currentProject = projectData;
              initializeProjectIDE();
              showToast('Project \'' + selectedProject + '\' loaded successfully!', 'success');
            })
            .catch((error) => {
              console.error("Error loading project from Firebase:", error);
              showToast('Failed to load project: ' + error.message, 'error');
            });
        } else {
          showToast('Project not found in local storage', 'error');
        }
      } catch (error) {
        console.error("Error loading project:", error);
        showToast('Error loading project: ' + error.message, 'error');
      }
    }

    function importSelectedProject() {
      const fileInput = document.getElementById('importFile');
      if (!fileInput.files.length) {
        showToast('Please select a file or folder to import', 'error');
        return;
      }

      // Process the imported files
      const projectName = fileInput.files[0].webkitRelativePath ?
        fileInput.files[0].webkitRelativePath.split('/')[0] :
        'Imported Project';

      currentProject = {
        name: projectName,
        type: 'custom',
        created: new Date().toISOString(),
        files: {}
      };

      // Use Promise.all to ensure all files are read before initializing IDE
      const filePromises = [];
      for (let i = 0; i < fileInput.files.length; i++) {
        const file = fileInput.files[i];
        const promise = new Promise((resolve) => {
          const reader = new FileReader();

          reader.onload = function(e) {
            // Store file content with full path
            const filePath = file.webkitRelativePath || file.name;
            currentProject.files[filePath] = e.target.result;
            resolve();
          };

          reader.readAsText(file);
        });

        filePromises.push(promise);
      }

      // Wait for all files to be processed before initializing the IDE
      Promise.all(filePromises)
        .then(() => {
          // Save the project after import
          try {
            const savedProjects = JSON.parse(localStorage.getItem('savedProjects') || '{}');
            savedProjects[currentProject.name] = currentProject;
            localStorage.setItem('savedProjects', JSON.stringify(savedProjects));

            // If Firebase is available, also save to Firebase Storage
            if (typeof firebase !== 'undefined' && storage) {
              const projectRef = storage.ref('projects/' + currentProject.name + '.json');
              const projectData = JSON.stringify(currentProject);

              projectRef.putString(projectData, 'raw')
                .then((snapshot) => {
                  initializeProjectIDE();
                  showToast('Project imported successfully as \'' + projectName + '\'!', 'success');
                })
                .catch((error) => {
                  console.error("Error saving imported project to Firebase:", error);
                  initializeProjectIDE();
                  showToast('Project imported successfully as \'' + projectName + '\'!', 'success');
                });
            } else {
              initializeProjectIDE();
              showToast('Project imported successfully as \'' + projectName + '\'!', 'success');
            }
          } catch (error) {
            console.error("Error saving imported project:", error);
            initializeProjectIDE();
            showToast('Project imported successfully as \'' + projectName + '\'!', 'success');
          }
        })
        .catch((error) => {
          console.error("Error processing imported files:", error);
          showToast('Error importing project: ' + error.message, 'error');
        });
    }

    function initializeProjectIDE() {
      // Create hierarchical file list with collapsible folders
      let fileListHTML = '';
      if (currentProject && currentProject.files) {
        // Create a tree structure from the file paths
        const fileTree = {};

        // Organize files into a directory structure
        for (const fileName in currentProject.files) {
          const parts = fileName.split('/');
          let currentLevel = fileTree;

          for (let i = 0; i < parts.length - 1; i++) {
            const dir = parts[i];
            if (!currentLevel[dir]) {
              currentLevel[dir] = { __isDir: true, children: {} };
            }
            currentLevel = currentLevel[dir].children;
          }

          // Add the file at the deepest level
          const file = parts[parts.length - 1];
          currentLevel[file] = { __isFile: true, name: file, fullPath: fileName };
        }

        // Track expanded directories
        if (!window.expandedDirs) window.expandedDirs = {};

        // Recursive function to render the tree structure
        function renderTree(tree, depth = 0, path = '') {
          let html = '';
          const indentClass = 'ml-' + (depth * 4);

          for (const key in tree) {
            const item = tree[key];
            const fullPath = path ? path + '/' + key : key;
            const isExpanded = window.expandedDirs[fullPath] || false;

            if (item.__isFile) {
              // Render file
              const ext = key.split('.').pop().toLowerCase();
              let iconColor = 'text-slate-300'; // default
              if (ext === 'js' || ext === 'ts') iconColor = 'text-yellow-400';
              else if (ext === 'html' || ext === 'htm') iconColor = 'text-orange-400';
              else if (ext === 'css') iconColor = 'text-blue-400';
              else if (ext === 'py') iconColor = 'text-green-400';
              else if (ext === 'java') iconColor = 'text-red-400';
              else if (ext === 'json' || ext === 'xml') iconColor = 'text-purple-400';

              html += '<div class="' + indentClass + '">' +
                '<div onclick="openFile(\'' + item.fullPath + '\')" class="flex items-center gap-2 p-2 rounded-lg hover:bg-slate-800 cursor-pointer text-slate-300">' +
                  '<svg class="w-4 h-4 ' + iconColor + '" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>' +
                  '<span>' + key + '</span>' +
                '</div>' +
              '</div>';
            } else if (item.__isDir) {
              // Render directory with toggle
              const isExpanded = window.expandedDirs[fullPath] || false;
              html += '<div class="' + indentClass + '">' +
                '<div onclick="toggleFolder(\'' + fullPath + '\')" class="flex items-center gap-2 p-2 rounded-lg text-slate-400 hover:bg-slate-800 cursor-pointer">' +
                  '<svg class="w-4 h-4 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                    (isExpanded ?
                      '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>' :
                      '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>') +
                  '</svg>' +
                  '<svg class="w-4 h-4 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>' +
                  '<span class="font-medium">' + key + '/</span>' +
                '</div>';

              // Only render children if the folder is expanded
              if (isExpanded) {
                html += renderTree(item.children, depth + 1, fullPath);
              }

              html += '</div>';
            }
          }

          return html;
        }

        fileListHTML = renderTree(fileTree);
      }

      // If no files, add default files
      if (!fileListHTML) {
        fileListHTML =
          '<div onclick="openFile(\'main.js\')" class="flex items-center gap-2 p-2 rounded-lg hover:bg-slate-800 cursor-pointer text-slate-300">' +
            '<svg class="w-4 h-4 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>' +
            '<span>main.js</span>' +
          '</div>' +
          '<div onclick="openFile(\'index.html\')" class="flex items-center gap-2 p-2 rounded-lg hover:bg-slate-800 cursor-pointer text-slate-300">' +
            '<svg class="w-4 h-4 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>' +
            '<span>index.html</span>' +
          '</div>' +
          '<div onclick="openFile(\'styles.css\')" class="flex items-center gap-2 p-2 rounded-lg hover:bg-slate-800 cursor-pointer text-slate-300">' +
            '<svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>' +
            '<span>styles.css</span>' +
          '</div>';
      }

      const content = document.getElementById('codeIDEContent');
      content.innerHTML =
        '<div class="flex flex-col h-[600px]">' +
          '<!-- Directory Bar with Controls -->' +
          '<div class="flex items-center justify-between border-b border-slate-700 pb-3 mb-3">' +
            '<div class="flex items-center gap-3">' +
              '<button onclick="showProjectManagement()" class="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg">' +
                '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>' +
              '</button>' +
              '<h2 class="text-lg font-semibold text-white">/Projects/' + currentProject.name + '</h2>' +
            '</div>' +

            '<div class="flex items-center gap-2">' +
              '<button onclick="createFolder()" class="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg" title="Create Folder">' +
                '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>' +
              '</button>' +
              '<button onclick="createFile()" class="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg" title="Create File">' +
                '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>' +
              '</button>' +
              '<button onclick="toggleDeleteMode()" class="p-2 text-slate-400 hover:text-red-400 hover:bg-slate-800 rounded-lg" title="Delete">' +
                '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>' +
              '</button>' +
              '<button onclick="exportProject()" class="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg" title="Export Project">' +
                '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>' +
              '</button>' +
              '<button onclick="openConsole()" class="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg" title="Console">' +
                '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>' +
              '</button>' +
            '</div>' +

            '<button onclick="saveProject()" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg flex items-center gap-2">' +
              '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>' +
              'Save' +
            '</button>' +
          '</div>' +

          '<!-- Main IDE Layout -->' +
          '<div class="flex flex-1 gap-4">' +
            '<!-- File Tree -->' +
            '<div class="w-1/4 border-r border-slate-700 pr-4">' +
              '<div class="text-sm font-medium text-slate-400 mb-2">PROJECT FILES</div>' +
              '<div id="fileTree" class="space-y-1">' +
                '<div class="flex items-center gap-2 p-2 rounded-lg bg-slate-800 text-white">' +
                  '<svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>' +
                  '<span>' + currentProject.name + '</span>' +
                '</div>' +
                '<div id="fileList" class="ml-4 space-y-1">' +
                  fileListHTML +
                '</div>' +
              '</div>' +
            '</div>' +

            '<!-- Code Editor -->' +
            '<div class="flex-1 flex flex-col">' +
              '<div id="editorTabs" class="flex border-b border-slate-700">' +
                '<div class="px-4 py-2 bg-slate-800 text-white border-r border-slate-700 text-sm">' +
                  (currentFile || 'main.js') +
                '</div>' +
              '</div>' +
              '<div class="flex-1 bg-slate-900 border border-slate-700 rounded-lg p-4 relative">' +
                '<textarea id="codeEditor" class="w-full h-full bg-slate-900 text-white font-mono text-sm outline-none resize-none" ' +
                  'placeholder="Start coding here...">' +
                  (currentProject && currentProject.files && currentProject.files[currentFile || 'main.js'] ? currentProject.files[currentFile || 'main.js'] : 'console.log(\\\'Hello, World!\\\');') +
                '</textarea>' +
                '<div id="errorPanel" class="absolute bottom-2 right-2 bg-red-900/80 text-red-200 text-xs px-2 py-1 rounded hidden">Errors Found</div>' +
              '</div>' +
            '</div>' +

            '<!-- Code Blocks Panel -->' +
            '<div class="w-1/4 border-l border-slate-700 pl-4 flex flex-col">' +
              '<div class="text-sm font-medium text-slate-400 mb-2">MINECRAFT CODE BLOCKS</div>' +
              '<div id="codeBlocksArea" class="space-y-2 flex-1">' +
                '<div class="grid grid-cols-1 gap-2">' +
                  '<button onclick="addExampleMod()" class="p-3 bg-slate-800 hover:bg-slate-700 rounded-lg text-white text-center">Example Mod</button>' +
                  '<button onclick="addExamplePlugin()" class="p-3 bg-slate-800 hover:bg-slate-700 rounded-lg text-white text-center">Example Plugin</button>' +
                  '<button onclick="addExampleAddon()" class="p-3 bg-slate-800 hover:bg-slate-700 rounded-lg text-white text-center">Example Addon</button>' +
                '</div>' +
              '</div>' +
              '<div class="mt-auto pt-4">' +
                '<div class="text-sm font-medium text-slate-400 mb-2">ERROR ANALYSIS</div>' +
                '<div id="errorAnalysis" class="bg-slate-800 rounded-lg p-3 text-xs max-h-40 overflow-y-auto">' +
                  'No errors detected in current file' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>';

      // Add a real-time check for errors when the user stops typing
      setTimeout(setupErrorChecking, 100);
    }

    function setupErrorChecking() {
      const editor = document.getElementById('codeEditor');
      if (editor) {
        let timeoutId;

        // Check for errors with a delay after the user stops typing
        editor.addEventListener('input', function() {
          clearTimeout(timeoutId);
          timeoutId = setTimeout(function() {
            checkForErrors(true); // Show results in error panel
          }, 1000); // Check 1 second after user stops typing
        });
      }
    }

    function showProjectManagement() {
      const content = document.getElementById('codeIDEContent');
      content.innerHTML =
        '<div class="text-center py-20">' +
          '<h3 class="text-xl font-semibold text-slate-300 mb-2">No Project Open</h3>' +
          '<p class="text-slate-500 mb-6">Start a new project or load an existing one</p>' +
          '<div class="flex justify-center gap-3">' +
            '<button onclick="newProject()" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg">' +
              'Create New Project' +
            '</button>' +
            '<button onclick="loadProject()" class="px-4 py-2 border border-slate-600 text-slate-300 hover:bg-slate-800 rounded-lg">' +
              'Load Project' +
            '</button>' +
          '</div>' +
        '</div>';
    }

    // Export Project Function
    function exportProject() {
      if (!currentProject) {
        showToast('No project to export!', 'error');
        return;
      }

      // Create a zip-like structure in memory
      const projectData = {
        name: currentProject.name,
        created: currentProject.created,
        files: currentProject.files,
        type: currentProject.type
      };

      // Create a blob with the project data
      const dataStr = JSON.stringify(projectData, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

      // Create download link
      const exportFileDefaultName = currentProject.name + '-project.json';

      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();

      showToast('Project exported successfully!', 'success');
    }

    // Console Function
    function openConsole() {
      // Create a console UI overlay
      const content = document.getElementById('codeIDEContent');
      content.innerHTML =
        '<div class="max-w-4xl mx-auto px-4 sm:px-6 py-8">' +
          '<div class="bg-slate-900 border border-slate-700 rounded-xl p-6">' +
            '<div class="flex items-center justify-between mb-4">' +
              '<h2 class="text-xl font-bold text-white">Console</h2>' +
              '<button onclick="initializeProjectIDE()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">Back to IDE</button>' +
            '</div>' +
            '<div class="mb-4">' +
              '<input type="text" id="consoleCommand" placeholder="Enter command..." ' +
                'class="w-full px-4 py-2 bg-slate-800 border border-slate-600 rounded-lg text-white placeholder:text-slate-500 outline-none focus:border-purple-500" ' +
                'onkeypress="handleConsoleKeyPress(event)" />' +
            '</div>' +
            '<div id="consoleOutput" class="h-64 bg-slate-800 rounded-lg p-4 font-mono text-sm text-slate-300 overflow-y-auto">' +
              '> Console ready. Enter a command.' +
            '</div>' +
          '</div>' +
        '</div>';
    }

    function handleConsoleKeyPress(event) {
      if (event.key === 'Enter') {
        executeConsoleCommand();
      }
    }

    function executeConsoleCommand() {
      const commandInput = document.getElementById('consoleCommand');
      const command = commandInput.value.trim();
      const outputDiv = document.getElementById('consoleOutput');

      if (!command) return;

      // Add the command to output
      outputDiv.innerHTML += '<br/>&gt; ' + command;

      // Process the command
      let result = '';
      try {
        // Simple command processing
        if (command.toLowerCase() === 'help') {
          result = 'Available commands: help, clear, project-info, clean, build, install-tools, run-mod\n> \n> NOTE: This online IDE can only simulate commands.\n> Real builds require local development environment with Gradle/Maven.\n> For actual development, visit:\n> GRADLE: https://gradle.org/\n> MAVEN: https://maven.apache.org/\n> JAVA: https://adoptium.net/';
        } else if (command.toLowerCase() === 'clear') {
          outputDiv.innerHTML = '';
          commandInput.value = '';
          return;
        } else if (command.toLowerCase() === 'project-info') {
          result = 'Project: ' + (currentProject ? currentProject.name : 'None') +
                   '<br/>Files: ' + (currentProject && currentProject.files ? Object.keys(currentProject.files).length : '0');
        } else if (command.toLowerCase() === 'clean') {
          // Check for build system and validate project
          const hasGradle = currentProject && currentProject.files && currentProject.files['build.gradle'];
          const hasMaven = currentProject && currentProject.files && currentProject.files['pom.xml'];

          if (hasGradle || hasMaven) {
            // Check for syntax errors in project files first
            let totalErrors = 0;
            let errorDetails = [];

            if (currentProject.files) {
              for (const fileName in currentProject.files) {
                if (fileName.endsWith('.java') || fileName.endsWith('.js')) {
                  const fileContent = currentProject.files[fileName];
                  const fileErrors = analyzeFileForErrors(fileContent, fileName);
                  totalErrors += fileErrors.count;
                  errorDetails = errorDetails.concat(fileErrors.details);
                }
              }
            }

            if (totalErrors === 0) {
              result = 'No Errors Found';
            } else {
              result = 'Errors Found (' + totalErrors + '):\n' + errorDetails.join('\n');
            }
          } else {
            result = 'No build system detected. Please add build.gradle for Gradle or pom.xml for Maven.';
          }
        } else if (command.toLowerCase() === 'build') {
          // Check for build system and validate project
          const hasGradle = currentProject && currentProject.files && currentProject.files['build.gradle'];
          const hasMaven = currentProject && currentProject.files && currentProject.files['pom.xml'];

          if (hasGradle || hasMaven) {
            // Check for syntax errors in project files
            let totalErrors = 0;
            let errorDetails = [];

            if (currentProject.files) {
              for (const fileName in currentProject.files) {
                if (fileName.endsWith('.java') || fileName.endsWith('.js')) {
                  const fileContent = currentProject.files[fileName];
                  const fileErrors = analyzeFileForErrors(fileContent, fileName);
                  totalErrors += fileErrors.count;
                  errorDetails = errorDetails.concat(fileErrors.details);
                }
              }
            }

            if (totalErrors === 0) {
              result = 'No Errors Found';
            } else {
              result = 'Errors Found (' + totalErrors + '):\n' + errorDetails.join('\n');
            }
          } else {
            result = 'No build system detected. Please add build.gradle for Gradle or pom.xml for Maven.';
          }
        } else if (command.toLowerCase() === 'install-tools') {
          result = 'Build tools cannot be installed in a browser environment.\n> The actual development requires:\n> - Java Development Kit (JDK 17+)\n> - Gradle 8.x OR Apache Maven 3.9+\n> - Integrated Development Environment (IDE)\n> \n> To set up a real development environment:\n> 1. Download and install JDK 17 or higher\n> 2. Install Gradle OR Maven\n> 3. Set up your IDE (IntelliJ IDEA, Eclipse, VSCode)\n> 4. Follow mod development tutorials\n> \n> This online IDE is for code editing only.';
        } else if (command.toLowerCase() === 'run-mod') {
          // Check for mod project and show what would happen
          const hasGradle = currentProject && currentProject.files && currentProject.files['build.gradle'];
          const hasMaven = currentProject && currentProject.files && currentProject.files['pom.xml'];
          const hasModInfo = currentProject && currentProject.files && (currentProject.files['src/main/resources/META-INF/mods.toml'] || currentProject.files['src/main/resources/fabric.mod.json'] || currentProject.files['mcmod.info']);

          if (hasModInfo) {
            if (hasGradle) {
              result = 'Mod cannot be run directly in browser environment.\n> In a real development environment:\n> 1. Your IDE would provide run configurations\n> 2. Minecraft would launch with your mod loaded\n> 3. You could test your mod in-game\n> \n> Current project has proper mod info file and Gradle build system.\n> \n> To run in reality:\n> - Use your IDE\'s run configuration\n> - Or execute: ./gradlew runClient\n> - Make sure you have proper forge/fabric dependencies';
            } else if (hasMaven) {
              result = 'Mod cannot be run directly in browser environment.\n> In a real development environment:\n> 1. Your IDE would provide run configurations\n> 2. Minecraft would launch with your mod loaded\n> 3. You could test your mod in-game\n> \n> Current project has proper mod info file and Maven build system.\n> \n> To run in reality:\n> - Use your IDE\'s run configuration\n> - Or execute: mvn clean compile exec:java -Dexec.mainClass\n> - Make sure you have proper forge/fabric dependencies';
            } else {
              result = 'Mod project detected but no build system found. Real development requires either:\n> - build.gradle file for Gradle, OR\n> - pom.xml file for Maven\n> \n> Create one of these files to enable proper building and running.';
            }
          } else {
            result = 'No mod project detected. To create a runnable mod you need:\n> 1. Proper mod info file (mods.toml, fabric.mod.json, or mcmod.info)\n> 2. Compatible build system (Gradle/Maven)\n> 3. Compatible code structure';
          }
        } else if (command.toLowerCase() === 'build') {
          // Check if project uses Gradle or Maven and note that actual build isn't possible
          const hasGradle = currentProject && currentProject.files && currentProject.files['build.gradle'];
          const hasMaven = currentProject && currentProject.files && currentProject.files['pom.xml'];

          if (hasGradle) {
            // Perform error check first
            const hasErrors = checkForErrors();
            if (hasErrors) {
              result = 'Build would fail due to code errors!\n> Please fix the errors shown in the error panel.\n> In a real development environment:\n> - Use terminal/command prompt\n> - Navigate to project directory\n> - Run: ./gradlew build\n> \n> Gradle build requires proper build.gradle file.';
            } else {
              result = 'Code appears error-free (browser check performed).\n> Actual build cannot be executed in browser.\n> \n> To build in a real environment:\n> 1. Open terminal in project directory\n> 2. Run command: ./gradlew build\n> 3. Find built JAR in /build/libs/ folder\n> \n> Visit: https://gradle.org/install/\n> Tutorial: gradle build';
            }
          } else if (hasMaven) {
            // Perform error check first
            const hasErrors = checkForErrors();
            if (hasErrors) {
              result = 'Build would fail due to code errors!\n> Please fix the errors shown in the error panel.\n> In a real development environment:\n> - Use terminal/command prompt\n> - Navigate to project directory\n> - Run: mvn package\n> \n> Maven build requires proper pom.xml file.';
            } else {
              result = 'Code appears error-free (browser check performed).\n> Actual build cannot be executed in browser.\n> \n> To build in a real environment:\n> 1. Open terminal in project directory\n> 2. Run command: mvn package\n> 3. Find built JAR in /target/ folder\n> \n> Visit: https://maven.apache.org/download.cgi\n> Tutorial: mvn clean package';
            }
          } else {
            result = 'No build system detected. Please add:\n> - build.gradle file for Gradle, OR\n> - pom.xml file for Maven\n> \n> Without build files, compilation is not possible.\n> \n> To learn more about build systems:\n> GRADLE: https://gradle.org/\n> MAVEN: https://maven.apache.org/';
          }
        } else if (command.toLowerCase() === 'clean') {
          // Check if project uses Gradle or Maven and note that actual cleaning isn't possible
          const hasGradle = currentProject && currentProject.files && currentProject.files['build.gradle'];
          const hasMaven = currentProject && currentProject.files && currentProject.files['pom.xml'];

          if (hasGradle) {
            result = 'Clean operation cannot be executed in browser.\n> \n> To clean in a real environment:\n> 1. Open terminal in project directory\n> 2. Run command: ./gradlew clean\n> 3. This removes built files from /build/ folder\n> \n> Visit: https://gradle.org/install/\n> Tutorial: gradle clean';
          } else if (hasMaven) {
            result = 'Clean operation cannot be executed in browser.\n> \n> To clean in a real environment:\n> 1. Open terminal in project directory\n> 2. Run command: mvn clean\n> 3. This removes built files from /target/ folder\n> \n> Visit: https://maven.apache.org/download.cgi\n> Tutorial: mvn clean';
          } else {
            result = 'No build system detected. Please add:\n> - build.gradle file for Gradle, OR\n> - pom.xml file for Maven\n> \n> Without build files, cleaning is not possible.\n> \n> To learn more about build systems:\n> GRADLE: https://gradle.org/\n> MAVEN: https://maven.apache.org/';
          }
        } else {
          result = 'Unknown command: ' + command + '. Type "help" for available commands.';
        }
      } catch (e) {
        result = 'Error: ' + e.message;
      }

      outputDiv.innerHTML += '<br/>' + result;
      outputDiv.scrollTop = outputDiv.scrollHeight; // Scroll to bottom

      commandInput.value = ''; // Clear the input
    }

    // Minecraft Code Blocks Functions


    function showModVersionSelection() {
      const codeBlocksArea = document.getElementById('codeBlocksArea');
      codeBlocksArea.innerHTML =
        '<div class="space-y-4">' +
          '<button onclick="showCodeBlockSelection()" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg mb-3">‚Üê Back</button>' +
          '<h3 class="text-lg font-semibold text-white mb-2">Java Mod Versions</h3>' +
          '<div class="grid grid-cols-1 gap-2 max-h-64 overflow-y-auto">' +
            // Combine all MC versions with Forge-specific versions
            ALL_MC_VERSIONS.map(version =>
              '<button onclick="selectModVersion(\'' + version + '\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">' + version + '</button>'
            ).join('') +
            // Additional Forge-specific versions
            '<button onclick="selectModVersion(\'1.21.1\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.21.1 (Forge compatible)</button>' +
            '<button onclick="selectModVersion(\'1.21.2\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.21.2 (Forge compatible)</button>' +
            '<button onclick="selectModVersion(\'1.21.3\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.21.3 (Forge compatible)</button>' +
            '<button onclick="selectModVersion(\'1.21.4\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.21.4 (Forge compatible)</button>' +
            '<button onclick="selectModVersion(\'1.21.5\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.21.5 (Forge compatible)</button>' +
            '<button onclick="selectModVersion(\'1.21.6\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.21.6 (Forge compatible)</button>' +
            '<button onclick="selectModVersion(\'1.21.7\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.21.7 (Forge compatible)</button>' +
            '<button onclick="selectModVersion(\'1.21.8\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.21.8 (Forge compatible)</button>' +
            '<button onclick="selectModVersion(\'1.21.9\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.21.9 (Forge compatible)</button>' +
            '<button onclick="selectModVersion(\'1.21.10\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.21.10 (Forge compatible)</button>' +
          '</div>' +
        '</div>';
    }

    function showAddonVersionSelection() {
      const codeBlocksArea = document.getElementById('codeBlocksArea');
      codeBlocksArea.innerHTML =
        '<div class="space-y-4">' +
          '<button onclick="showCodeBlockSelection()" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg mb-3">‚Üê Back</button>' +
          '<h3 class="text-lg font-semibold text-white mb-2">Addon Versions</h3>' +
          '<div class="grid grid-cols-1 gap-2 max-h-64 overflow-y-auto">' +
            // Bedrock addon versions
            '<button onclick="selectAddonVersion(\'1.21.101\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.21.101 - Next major update</button>' +
            '<button onclick="selectAddonVersion(\'1.21.100\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.21.100 - Following release</button>' +
            '<button onclick="selectAddonVersion(\'1.21.94\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.21.94 - Hotfix build</button>' +
            '<button onclick="selectAddonVersion(\'1.21.90\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.21.90 - "Chase the Skies" update</button>' +
            '<button onclick="selectAddonVersion(\'1.21.80\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.21.80 - Later update</button>' +
            '<button onclick="selectAddonVersion(\'1.21.70\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.21.70 - "Spring to Life" update</button>' +
            '<button onclick="selectAddonVersion(\'1.21.60\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.21.60 - Patch update</button>' +
            '<button onclick="selectAddonVersion(\'1.21.50\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.21.50 - "The Garden Awakens"</button>' +
            '<button onclick="selectAddonVersion(\'1.20.80\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.20.80</button>' +
            '<button onclick="selectAddonVersion(\'1.20.71\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.20.71</button>' +
            '<button onclick="selectAddonVersion(\'1.20.60\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.20.60</button>' +
            '<button onclick="selectAddonVersion(\'1.20.50\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.20.50</button>' +
            '<button onclick="selectAddonVersion(\'1.20.40\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.20.40</button>' +
            '<button onclick="selectAddonVersion(\'1.20.30\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.20.30</button>' +
            '<button onclick="selectAddonVersion(\'1.20.10\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.20.10</button>' +
            '<button onclick="selectAddonVersion(\'1.19.80\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.19.80</button>' +
            '<button onclick="selectAddonVersion(\'1.19.70\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.19.70</button>' +
            '<button onclick="selectAddonVersion(\'1.19.63\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.19.63</button>' +
            '<button onclick="selectAddonVersion(\'1.19.60\')" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.19.60</button>' +
          '</div>' +
        '</div>';
    }

    function selectAddonVersion(version) {
      showModCodeBlocks(version, 'addon');
    }

    function selectModVersion(version) {
      showModCodeBlocks(version, 'mod');
    }

    function showPluginTypeSelection() {
      const codeBlocksArea = document.getElementById('codeBlocksArea');
      codeBlocksArea.innerHTML =
        '<div class="space-y-4">' +
          '<button onclick="showCodeBlockSelection()" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg mb-3">‚Üê Back</button>' +
          '<h3 class="text-lg font-semibold text-white mb-2">Select Plugin Platform</h3>' +
          '<div class="space-y-2">' +
            '<button onclick="selectPluginPlatform(\'spigot\')" class="w-full p-3 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-center">Spigot</button>' +
            '<button onclick="selectPluginPlatform(\'paper\')" class="w-full p-3 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-center">Paper</button>' +
            '<button onclick="selectPluginPlatform(\'bukkit\')" class="w-full p-3 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-center">Bukkit</button>' +
            '<button onclick="selectPluginPlatform(\'forge\')" class="w-full p-3 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-center">Forge (Mod)</button>' +
          '</div>' +
        '</div>';
    }

    function selectPluginPlatform(platform) {
      // For plugins, we'll use a common version selection in the sidebar
      const codeBlocksArea = document.getElementById('codeBlocksArea');
      codeBlocksArea.innerHTML =
        '<div class="space-y-4">' +
          '<button onclick="showPluginTypeSelection()" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg mb-3">‚Üê Back</button>' +
          '<h3 class="text-lg font-semibold text-white mb-2">Select ' + platform + ' Version</h3>' +
          '<div class="space-y-2 max-h-64 overflow-y-auto">' +
            // Common server versions
            '<button onclick="selectPluginVersion(\'' + platform + '\', \'1.20.4\')" class="w-full p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.20.4</button>' +
            '<button onclick="selectPluginVersion(\'' + platform + '\', \'1.19.4\')" class="w-full p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.19.4</button>' +
            '<button onclick="selectPluginVersion(\'' + platform + '\', \'1.18.2\')" class="w-full p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.18.2</button>' +
            '<button onclick="selectPluginVersion(\'' + platform + '\', \'1.17.1\')" class="w-full p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.17.1</button>' +
            '<button onclick="selectPluginVersion(\'' + platform + '\', \'1.16.5\')" class="w-full p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.16.5</button>' +
            '<button onclick="selectPluginVersion(\'' + platform + '\', \'1.12.2\')" class="w-full p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.12.2</button>' +
            '<button onclick="selectPluginVersion(\'' + platform + '\', \'1.21.1\')" class="w-full p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.21.1</button>' +
            '<button onclick="selectPluginVersion(\'' + platform + '\', \'1.21.3\')" class="w-full p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white text-left">1.21.3</button>' +
          '</div>' +
        '</div>';
    }

    function selectPluginVersion(platform, version) {
      showModCodeBlocks(version, platform);
    }

    function showModCodeBlocks(version, type) {
      const codeBlocksArea = document.getElementById('codeBlocksArea');
      codeBlocksArea.innerHTML =
        '<div class="space-y-4">' +
          '<button onclick="' + (type === 'mod' || type === 'addon' ? 'showModVersionSelection()' : 'selectPluginPlatform(\'' + type + '\')') + '" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg mb-3">‚Üê Back</button>' +
          '<h3 class="text-lg font-semibold text-white mb-2">Code Blocks for ' + type + ' (' + version + ')</h3>' +
          '<div class="space-y-4">' +
            '<div>' +
              '<h4 class="font-medium text-slate-300 mb-2">Initialization Blocks</h4>' +
              '<div class="space-y-2 max-h-48 overflow-y-auto">' +
                // Different initialization methods based on type/version
                getInitializationBlocks(type, version) +
              '</div>' +
            '</div>' +
            '<div>' +
              '<h4 class="font-medium text-slate-300 mb-2">Configuration Blocks</h4>' +
              '<div class="space-y-2 max-h-32 overflow-y-auto">' +
                getConfigBlocks(type) +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>';
    }

    function getInitializationBlocks(type, version) {
      let blocks = '';

      if (type === 'fabric') {
        blocks += '<button onclick="insertCodeBlock(\'fabric_onInitialize\')" class="p-4 bg-slate-800 hover:bg-slate-700 rounded-lg text-left w-full">' +
                  '<div class="font-medium text-purple-300">onInitialize</div>' +
                  '<div class="text-xs text-slate-400 mt-1">Called when the mod is initialized</div>' +
                  '</button>';
      } else if (type === 'forge') {
        blocks += '<button onclick="insertCodeBlock(\'forge_onInitialize\')" class="p-4 bg-slate-800 hover:bg-slate-700 rounded-lg text-left w-full">' +
                  '<div class="font-medium text-purple-300">Forge Mod Constructor & Events</div>' +
                  '<div class="text-xs text-slate-400 mt-1">@Mod constructor, FMLCommonSetupEvent, FMLClientSetupEvent</div>' +
                  '</button>';
        blocks += '<button onclick="insertCodeBlock(\'forge_onDisable\')" class="p-4 bg-slate-800 hover:bg-slate-700 rounded-lg text-left w-full">' +
                  '<div class="font-medium text-purple-300">Forge Server Shutdown Events</div>' +
                  '<div class="text-xs text-slate-400 mt-1">ServerStoppingEvent, ServerStoppedEvent</div>' +
                  '</button>';
      } else if (type === 'spigot' || type === 'paper' || type === 'bukkit') {
        blocks += '<button onclick="insertCodeBlock(\'plugin_onEnable\')" class="p-4 bg-slate-800 hover:bg-slate-700 rounded-lg text-left w-full">' +
                  '<div class="font-medium text-purple-300">onEnable</div>' +
                  '<div class="text-xs text-slate-400 mt-1">Called when the plugin is enabled</div>' +
                  '</button>';
        blocks += '<button onclick="insertCodeBlock(\'plugin_onDisable\')" class="p-4 bg-slate-800 hover:bg-slate-700 rounded-lg text-left w-full">' +
                  '<div class="font-medium text-purple-300">onDisable</div>' +
                  '<div class="text-xs text-slate-400 mt-1">Called when the plugin is disabled</div>' +
                  '</button>';
      } else { // Default for mod or addon
        blocks += '<button onclick="insertCodeBlock(\'onEnable\')" class="p-4 bg-slate-800 hover:bg-slate-700 rounded-lg text-left w-full">' +
                  '<div class="font-medium text-purple-300">onEnable</div>' +
                  '<div class="text-xs text-slate-400 mt-1">Mod initialization</div>' +
                  '</button>';
        blocks += '<button onclick="insertCodeBlock(\'onDisable\')" class="p-4 bg-slate-800 hover:bg-slate-700 rounded-lg text-left w-full">' +
                  '<div class="font-medium text-purple-300">onDisable</div>' +
                  '<div class="text-xs text-slate-400 mt-1">Mod cleanup</div>' +
                  '</button>';
      }

      return blocks;
    }

    function getConfigBlocks(type) {
      let blocks = '';

      // Configuration blocks for all types
      blocks += '<button onclick="insertCodeBlock(\'loadConfig\')" class="p-4 bg-slate-800 hover:bg-slate-700 rounded-lg text-left w-full">' +
                '<div class="font-medium text-purple-300">loadConfig</div>' +
                '<div class="text-xs text-slate-400 mt-1">Load configuration files</div>' +
                '</button>';

      blocks += '<button onclick="insertCodeBlock(\'saveConfig\')" class="p-4 bg-slate-800 hover:bg-slate-700 rounded-lg text-left w-full">' +
                '<div class="font-medium text-purple-300">saveConfig</div>' +
                '<div class="text-xs text-slate-400 mt-1">Save configuration files</div>' +
                '</button>';

      return blocks;
    }

    function insertCodeBlock(blockType) {
      // Create a fake event to reuse the existing dropBlock function logic
      const fakeEvent = { preventDefault: () => {} };
      const editor = document.getElementById('codeEditor');

      // Check if the function already exists in the code
      const code = editor.value;
      let functionExists = false;

      if (blockType === 'onEnable' || blockType === 'plugin_onEnable') {
        functionExists = code.includes('function onEnable') || code.includes('public void onEnable');
      } else if (blockType === 'onDisable' || blockType === 'plugin_onDisable') {
        functionExists = code.includes('function onDisable') || code.includes('public void onDisable');
      } else if (blockType === 'fabric_onInitialize') {
        functionExists = code.includes('void onInitialize');
      } else if (blockType === 'forge_onInitialize') {
        functionExists = code.includes('FMLClientSetupEvent') || code.includes('FMLCommonSetupEvent') || code.includes('@Mod(');
      } else if (blockType === 'forge_onDisable') {
        functionExists = code.includes('ServerStoppingEvent') || code.includes('ServerStoppedEvent');
      } else if (blockType === 'loadConfig') {
        functionExists = code.includes('loadConfig');
      } else if (blockType === 'saveConfig') {
        functionExists = code.includes('saveConfig');
      }

      if (functionExists) {
        showToast('The ' + blockType + ' function already exists in this file!', 'error');
        return;
      }

      // Insert the appropriate code block based on type
      let insertCode = '';
      if (blockType === 'onEnable' || blockType === 'plugin_onEnable') {
        // Analyze the code to determine what needs initialization
        const hasConfigs = code.includes('config') || code.includes('Config') || code.includes('.json');
        const hasDatabase = code.includes('database') || code.includes('Database') || code.includes('sql');
        const hasAPI = code.includes('fetch') || code.includes('axios') || code.includes('request');

        insertCode = 'function onEnable() {\n';

        if (hasConfigs) {
          insertCode += '  // Load configuration\n  loadConfig();\n';
        }
        if (hasDatabase) {
          insertCode += '  // Initialize database connection\n  initDatabase();\n';
        }
        if (hasAPI) {
          insertCode += '  // Setup API endpoints\n  setupAPI();\n';
        }

        insertCode += '  console.log("Plugin/Mod enabled successfully!");\n}\n';
        showToast('OnEnable function added with automatic initialization!', 'success');
      } else if (blockType === 'onDisable' || blockType === 'plugin_onDisable') {
        // Analyze the code to determine what needs cleanup
        const hasConfigs = code.includes('config') || code.includes('Config');
        const hasDatabase = code.includes('database') || code.includes('Database');
        const hasServer = code.includes('server') || code.includes('Server') || code.includes('listen');

        insertCode = 'function onDisable() {\n';

        if (hasServer) {
          insertCode += '  // Close server connections\n  closeServer();\n';
        }
        if (hasDatabase) {
          insertCode += '  // Close database connection\n  closeDatabase();\n';
        }
        if (hasConfigs) {
          insertCode += '  // Save configuration\n  saveConfig();\n';
        }

        insertCode += '  console.log("Plugin/Mod disabled successfully!");\n}\n';
        showToast('OnDisable function added with automatic cleanup!', 'success');
      } else if (blockType === 'fabric_onInitialize') {
        insertCode = '// This method is called when the mod is initialized\npublic void onInitialize() {\n  // Initialize your mod here\n  System.out.println("MyFabricMod is loading!");\n}\n';
        showToast('Fabric onInitialize method added!', 'success');
      } else if (blockType === 'forge_onInitialize') {
        // Use the proper Forge onEnable equivalent methods
        insertCode = '@Mod("' + (currentProject?.name.toLowerCase().replace(/\s+/g, '') || 'mymod') + '")\n' +
                     'public class ' + (currentProject?.name.charAt(0).toUpperCase() + currentProject?.name.slice(1).replace(/\s+/g, '') || 'MyMod') + ' {\n' +
                     '    public ' + (currentProject?.name.charAt(0).toUpperCase() + currentProject?.name.slice(1).replace(/\s+/g, '') || 'MyMod') + '() {\n' +
                     '        // Mod constructor - Forge "onEnable" equivalent\n' +
                     '        System.out.println("' + (currentProject?.name || 'MyMod') + ' loaded!");\n' +
                     '    }\n' +
                     '}\n\n' +
                     '@Mod.EventBusSubscriber(bus = Mod.EventBusSubscriber.Bus.MOD)\n' +
                     'public class CommonSetup {\n' +
                     '    @SubscribeEvent\n' +
                     '    public static void onCommonSetup(FMLCommonSetupEvent event) {\n' +
                     '        // Forge "onEnable" - Main initialization\n' +
                     '        System.out.println("Common setup running");\n' +
                     '    }\n' +
                     '}\n\n' +
                     '@Mod.EventBusSubscriber(value = Dist.CLIENT, bus = Mod.EventBusSubscriber.Bus.MOD)\n' +
                     'public class ClientSetup {\n' +
                     '    @SubscribeEvent\n' +
                     '    public static void onClientSetup(FMLClientSetupEvent event) {\n' +
                     '        // Forge "onEnable" - Client initialization\n' +
                     '        System.out.println("Client setup running");\n' +
                     '    }\n' +
                     '}';
        showToast('Forge proper onEnable equivalent methods added!', 'success');
      } else if (blockType === 'forge_onDisable') {
        // Use the proper Forge onDisable equivalent methods
        insertCode = '@Mod.EventBusSubscriber(bus = Mod.EventBusSubscriber.Bus.FORGE)\n' +
                     'public class ServerEvents {\n' +
                     '    @SubscribeEvent\n' +
                     '    public static void onServerStopping(ServerStoppingEvent event) {\n' +
                     '        // Forge "onDisable" - Server shutdown\n' +
                     '        System.out.println("Server stopping, mod cleanup...");\n' +
                     '    }\n\n' +
                     '    @SubscribeEvent\n' +
                     '    public static void onServerStopped(ServerStoppedEvent event) {\n' +
                     '        // Forge "onDisable" - Server fully stopped\n' +
                     '        System.out.println("Server stopped, mod cleanup complete...");\n' +
                     '    }\n' +
                     '}';
        showToast('Forge proper onDisable equivalent methods added!', 'success');
      } else if (blockType === 'loadConfig') {
        insertCode = 'function loadConfig() {\n  // Load configuration file\n  try {\n    // Load config file\n    console.log("Configuration loaded!");\n  } catch (error) {\n    console.error("Error loading config:", error);\n  }\n}\n';
        showToast('loadConfig function added!', 'success');
      } else if (blockType === 'saveConfig') {
        insertCode = 'function saveConfig() {\n  // Save configuration file\n  try {\n    // Save config file\n    console.log("Configuration saved!");\n  } catch (error) {\n    console.error("Error saving config:", error);\n  }\n}\n';
        showToast('saveConfig function added!', 'success');
      }

      editor.value += '\n\n' + insertCode;

      // Check for syntax errors after insertion
      checkForErrors();
    }

    function addExampleMod() {
      if (!currentProject) {
        showToast('Please create a project first!', 'error');
        return;
      }

      // Initialize files object if it doesn't exist
      if (!currentProject.files) {
        currentProject.files = {};
      }

      // Add files for the example mod
      currentProject.files['build.gradle'] = `plugins {
    id 'java'
    id 'eclipse'
    id 'idea'
    id 'net.minecraftforge.gradle' version '[6.0,6.2)'
}

version = '1.0.0'
group = 'com.example.examplemod'

java.toolchain.languageVersion = JavaLanguageVersion.of(17)

println "Java: \${System.getProperty 'java.version'}, JVM: \${System.getProperty 'java.vm.version'} (\${System.getProperty 'java.vendor'}), Arch: \${System.getProperty 'os.arch'}"

minecraft {
    mappings channel: 'official', version: '1.20.1'

    copyIdeConfiguration = true

    runs {
        configureEach {
            workingDirectory project.file('run')

            property 'forge.logging.markers', 'REGISTRIES'
            property 'forge.logging.console.level', 'debug'

            mods {
                examplemod {
                    source sourceSets.main
                }
            }
        }

        client {
            property 'forge.enabledGameTestNamespaces', 'examplemod'
        }

        server {
            property 'forge.enabledGameTestNamespaces', 'examplemod'
            args '--nogui'
        }

        data {
            args '--mod', 'examplemod', '--all', '--output', file('src/generated/resources/'), '--existing', file('src/main/resources/')
        }
    }
}

dependencies {
    minecraft 'net.minecraftforge:forge:1.20.1-47.2.20'
}

tasks.withType(JavaCompile).configureEach {
    options.encoding = 'UTF-8'
}
`;

      currentProject.files['src/main/java/com/example/examplemod/ExampleMod.java'] = `package com.example.examplemod;

import net.minecraftforge.fml.common.Mod;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

@Mod("examplemod")
public class ExampleMod {

    public static final String MODID = "examplemod";
    public static final Logger LOGGER = LogManager.getLogger(MODID);

    public ExampleMod() {
        // Constructor - acts like onEnable
        LOGGER.info("Example Mod is loading!");
    }
}
`;

      currentProject.files['src/main/resources/META-INF/mods.toml'] = `modLoader="javafml"
loaderVersion="[47,)"
license="MIT"

[[mods]]
modId="examplemod"
version="1.0.0"
displayName="Example Mod"
authors="Your Name"
description="An example mod to demonstrate Forge modding concepts."

[[dependencies.examplemod]]
modId="forge"
mandatory=true
versionRange="[47,)"
ordering="NONE"
side="BOTH"

[[dependencies.examplemod]]
modId="minecraft"
mandatory=true
versionRange="[1.20.1,1.21)"
ordering="NONE"
side="BOTH"
`;

      // Refresh the UI to show the new files
      initializeProjectIDE();
      showToast('Example mod files added successfully!', 'success');
    }

    function addExamplePlugin() {
      if (!currentProject) {
        showToast('Please create a project first!', 'error');
        return;
      }

      if (!currentProject.files) {
        currentProject.files = {};
      }

      currentProject.files['plugin.yml'] = `name: ExamplePlugin
version: 1.0.0
main: com.example.exampleplugin.ExamplePlugin
api-version: 1.20
author: Your Name
description: An example plugin
website: https://yourwebsite.com
`;

      currentProject.files['src/main/java/com/example/exampleplugin/ExamplePlugin.java'] = `package com.example.exampleplugin;

import org.bukkit.plugin.java.JavaPlugin;

public class ExamplePlugin extends JavaPlugin {

    @Override
    public void onEnable() {
        getLogger().info("Example Plugin has been enabled!");
    }

    @Override
    public void onDisable() {
        getLogger().info("Example Plugin has been disabled.");
    }
}
`;

      currentProject.files['pom.xml'] = `<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.example</groupId>
    <artifactId>exampleplugin</artifactId>
    <version>1.0.0</version>
    <packaging>jar</packaging>

    <properties>
        <maven.compiler.source>17</maven.compiler.source>
        <maven.compiler.target>17</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    </properties>

    <repositories>
        <repository>
            <id>spigot-repo</id>
            <url>https://hub.spigotmc.org/nexus/content/repositories/snapshots/</url>
        </repository>
    </repositories>

    <dependencies>
        <dependency>
            <groupId>org.spigotmc</groupId>
            <artifactId>spigot-api</artifactId>
            <version>1.20.1-R0.1-SNAPSHOT</version>
            <scope>provided</scope>
        </dependency>
    </dependencies>

    <build>
        <defaultGoal>clean install</defaultGoal>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.8.1</version>
                <configuration>
                    <source>17</source>
                    <target>17</target>
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-shade-plugin</artifactId>
                <version>3.2.4</version>
                <executions>
                    <execution>
                        <phase>package</phase>
                        <goals>
                            <goal>shade</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
        </plugins>
    </build>
</project>
`;

      // Refresh the UI to show the new files
      initializeProjectIDE();
      showToast('Example plugin files added successfully!', 'success');
    }

    function addExampleAddon() {
      if (!currentProject) {
        showToast('Please create a project first!', 'error');
        return;
      }

      if (!currentProject.files) {
        currentProject.files = {};
      }

      currentProject.files['manifest.json'] = `{
    "format_version": 2,
    "header": {
        "name": "Example Addon",
        "description": "An example Minecraft Bedrock addon",
        "uuid": "12345678-1234-1234-1234-123456789abc",
        "version": [1, 0, 0],
        "min_engine_version": [1, 20, 0]
    },
    "modules": [
        {
            "type": "data",
            "uuid": "87654321-4321-4321-4321-cba987654321",
            "version": [1, 0, 0],
            "description": "Example addon data"
        }
    ]
}`;

      currentProject.files['BP/blocks.json'] = `{
    "format_version": "1.20.10",
    "minecraft:block": {
        "description": {
            "identifier": "examplemod:my_block"
        },
        "components": {
            "minecraft:destroy_time": 1.5,
            "minecraft:block_light_emission": 0.5,
            "minecraft:block_light_absorption": 0
        }
    }
}`;

      currentProject.files['RP/textures/item_texture.json'] = `{
    "resource_pack_name": "example_pack",
    "texture_name": "atlas.items",
    "texture_data": {
        "my_item": {
            "textures": "textures/items/my_item"
        }
    }
}`;

      // Refresh the UI to show the new files
      initializeProjectIDE();
      showToast('Example addon files added successfully!', 'success');
    }

    function setImportType(type) {
      // Highlight the selected import type button
      document.getElementById('importTypeFile').classList.remove('bg-purple-600', 'text-white');
      document.getElementById('importTypeFile').classList.add('border-slate-600', 'text-slate-300');
      document.getElementById('importTypeFolder').classList.remove('bg-purple-600', 'text-white');
      document.getElementById('importTypeFolder').classList.add('border-slate-600', 'text-slate-300');

      if (type === 'file') {
        document.getElementById('importTypeFile').classList.add('bg-purple-600', 'text-white');
        document.getElementById('importTypeFile').classList.remove('border-slate-600', 'text-slate-300');
      } else {
        document.getElementById('importTypeFolder').classList.add('bg-purple-600', 'text-white');
        document.getElementById('importTypeFolder').classList.remove('border-slate-600', 'text-slate-300');
      }

      // Update the file input to accept folders if needed
      const fileInput = document.getElementById('importFile');
      if (type === 'folder') {
        fileInput.setAttribute('webkitdirectory', '');
        fileInput.setAttribute('directory', '');
        fileInput.setAttribute('multiple', '');
      } else {
        fileInput.removeAttribute('webkitdirectory');
        fileInput.removeAttribute('directory');
        fileInput.removeAttribute('multiple');
      }
    }

    function createFolder() {
      const folderName = prompt('Enter folder name:');
      if (folderName) {
        // In the current implementation, we don't have folder structure in the files object,
        // but we could implement it in the future by storing folder paths like 'folder/file.js'
        showToast('Folder \'' + folderName + '\' created!', 'success');
        // Refresh the IDE to reflect changes
        if (currentProject) {
          initializeProjectIDE();
        }
      }
    }

    function createFile() {
      const fileName = prompt('Enter file name:');
      if (fileName) {
        if (!currentProject) {
          showToast('No project open!', 'error');
          return;
        }

        // Initialize files object if it doesn't exist
        if (!currentProject.files) {
          currentProject.files = {};
        }

        // Check if file already exists
        if (currentProject.files[fileName]) {
          showToast('File \'' + fileName + '\' already exists!', 'error');
          return;
        }

        // Check if this is a common mod file that should have template content
        let fileContent = '';
        if (fileName === 'build.gradle') {
          fileContent = `plugins {
    id 'java'
    id 'eclipse'
    id 'idea'
}

version = '1.0'
group = 'com.yourname.modid' // http://maven.apache.org/guides/mini/guide-naming-conventions.html

base {
    archivesName = 'modid'
}

// Mojang ships Java 17 to end users in 1.18+, so your mod should target Java 17.
java.toolchain.languageVersion = JavaLanguageVersion.of(17)

println "Java: \${System.getProperty 'java.version'}, JVM: \${System.getProperty 'java.vm.version'} (\${System.getProperty 'java.vendor'}), Arch: \${System.getProperty 'os.arch'}"
minecraft.accessTransformers.file rootProject.file('src/main/resources/META-INF/accesstransformer.cfg')
// Default run configurations.
// These can be tweaked, removed, or duplicated as needed.
runs {
    // applies to all the run configs below
    configureEach {
        // Recommended logging data for Mixin
        property 'mixin.env.remapRefMap', 'true'
        property 'mixin.env.refMapRemappingFile', project.file('build/createSrgToMcp/output.srg')

        // If you remove this, you won't be able to use the remapped dependency configurations
        // in any of the run configs below.
        // It is recommended to install IntelliJ's Mixin plugin for better IDE support
        arg "-mixin.config=modid.mixins.json"

        // You can change the amount of memory here
        jvmArgs '-Xmx4G'
    }

    client {
        // The main class location
        property 'forge.gamepack.client', project.file('run').toAbsolutePath().toString()
        args '--username', 'Dev'
        // You can specify the window size, or whether it's fullscreen
        // property 'forge.window.size', '856x482'
        // property 'forge.window.fullscreen', 'true'
    }

    server {
        // The main class location
        property 'forge.gamepack.server', project.file('run_server').toAbsolutePath().toString()
        args 'nogui'
    }

    data {
        // example of using a specific modid
        args '--mod', 'modid', '--all', '--output', file('src/generated/resources/'), '--existing', file('src/main/resources/')
    }
}

// Include resources generated by data generators.
sourceSets.main.resources { srcDir 'src/generated/resources' }

repositories {
    // Put repositories for dependencies here
    // ForgeGradle automatically adds the Forge maven, so this is for other dependencies.
}

dependencies {
    // Specify the version of Minecraft to use, If this is any group other then 'net.minecraftforge' it is assumed
    // that the dep is a ForgeGradle 'patcher' dependency, and its patches will be applied.
    // The userdev artifact is a special name and will get all sorts of transformations applied to it.
    minecraft 'net.minecraftforge:forge:1.20.4-49.0.31'

    // Example mod dependency with JEI
    // The JEI API is declared for compile time use, while the full JEI artifact is used at runtime
    // compileOnly "mezz.jei:jei-1.20.4-common-api:15.1.0.4"
    // compileOnly "mezz.jei:jei-1.20.4-forge-api:15.1.0.4"
    // runtimeOnly "mezz.jei:jei-1.20.4-forge:15.1.0.4"

    // Example mod dependency using the mod's maven coordinates
    // This adds the mod as a dependency to your project. It will be downloaded from the maven your repository declares.
    // runtimeOnly "curse.maven:forge-123456:234567"
    // This adds the mod's API as compileOnly dependency to your project. It will be downloaded from the maven your repository declares.
    // compileOnly "curse.maven:forge-api-123456:234567"
}

// This block of code expands all the *repositories* closures in the dependencies block and adds them to the project.
// This is used to add the Curse Maven to the project which is required for some dependencies.
// The buildscript block is used to add the Curse Maven to the project for the buildscript.
// If you're not using any Curse Maven dependencies, you can remove this block.
// This is a temporary solution until ForgeGradle supports the Curse Maven natively.
afterEvaluate {
    configurations.configureEach {
        resolutionStrategy {
            dependencySubstitution {
                // Example mod dependency substitution using the mod's maven coordinates
                // substitute module('curse.maven:forge-123456') using module('curse.maven:forge-123456:234567') allVariants {
                    transitive = false
                }
            }
        }
    }
}`;
        } else if (fileName === 'src/main/resources/META-INF/mods.toml') {
          fileContent = `# This is an example mods.toml file. It contains the data relating to your mod. There are several mandatory fields (#mandatory), and many others that are optional (#optional).
# The overall format is standard TOML format, v0.5.0.
# Note that there are a couple of TOML features that are not supported:
# Comments cannot be on the same line as a field definition
# Array of Tables (see https://github.com/toml-lang/toml/blob/v0.5.0/README.md#array-of-tables)

# The name of the mod loader type to load - for regular FML @Mod mods it should be javafml
modLoader="javafml" #mandatory
# A version range to match for said mod loader - for regular FML @Mod it will be the forge version
loaderVersion="[47,)" #mandatory This is typically bumped every Minecraft version by Forge. See our download page for lists of versions.
# The license for you mod. This is mandatory metadata and allows for easier comprehension of your redistributive properties.
# Consult a lawyer if you do not understand the implications of the license you select.
license="MIT"

# A URL to refer people to when problems occur with this mod
#issueTrackerURL="https://change.me.to.your.issue.tracker.example.invalid/" #optional

[[mods]] #mandatory
# The modid for the mod
modId="myawesome_mod" #mandatory
# The version number of the mod - ${version} is the recommended approach for displaying the version
version="${version}" #mandatory
# A display name for the mod
displayName="My Awesome Mod" #mandatory
# A URL to query for updates for this mod. See the JSON update specification https://docs.minecraftforge.net/en/latest/misc/updatechecker/
#updateJSONURL="https://change.me.example.invalid/updates.json" #optional
# A URL for the "homepage" for this mod, displayed in the mod UI
#displayURL="https://change.me.to.your.mods.homepage.example.invalid/" #optional
# A file name (in the root of the mod JAR) containing a logo for display
#logoFile="myawesomemod.png" #optional
# A text field displayed in the mod UI
#credits="Thanks for this example mod goes to Java" #optional
# A text field displayed in the mod UI
authors="YourName" #optional
# Display Test controls the display for this mod in the server connection screen
# MATCH_VERSION means that your mod will cause a red X if the versions on client and server differ. This is the default behaviour and should be what you choose if you have server and client elements to your mod.
# IGNORE_SERVER_VERSION means that your mod will not cause a red X if it's present on the server but not on the client. This is what you should use if you're a server only mod.
# IGNORE_ALL_VERSION means that your mod will not cause a red X if it's present on the client or the server. This is a special case and should only be used if your mod has absolutely no compatibilty requirements.
# NONE means that no display test is set on your mod. You need to do this yourself, see IExtensionPoint.DisplayTest for more information. You can define any scheme you wish with this value.
# IMPORTANT NOTE: detail formatting is subject to change
displayTest="MATCH_VERSION" # MATCH_VERSION is the default if nothing is specified (#optional)

# The description text for the mod (multi line!) (#mandatory)
description='''This is a long form description of the mod. You can write anything you want here'''

# A dependency - use the . to indicate dependency for a specific modid. Dependencies are optional.
[[dependencies.myawesome_mod]] #optional
    # the modid of the dependency
    modId="forge" #mandatory
    # Does this dependency have to exist - if not, ordering below must be specified
    mandatory=true #mandatory
    # The version range of the dependency
    versionRange="[47,)" #mandatory
    # An ordering relationship for the dependency - BEFORE or AFTER required if the relationship is not mandatory
    ordering="NONE"
    # Side this dependency is applied on - BOTH, CLIENT or SERVER
    side="BOTH"
# Another dependency example forminecraft itself
[[dependencies.myawesome_mod]]
    modId="minecraft"
    mandatory=true
    # This version range declares a minimum of the current minecraft version up to but not including the next major version
    versionRange="[1.20.4,1.21)"
    ordering="NONE"
    side="BOTH"`;
        } else if (fileName === 'src/main/resources/fabric.mod.json') {
          fileContent = `{
  "schemaVersion": 1,
  "id": "myfabulousmod",
  "version": "\${version}",

  "name": "My Fabulous Mod",
  "description": "This is an example description! Tell everyone what your mod is about!",
  "authors": [
    "Me!"
  ],
  "contact": {
    "homepage": "https://fabricmc.net/",
    "sources": "https://github.com/FabricMC/fabric-example-mod"
  },

  "license": "CC0-1.0",
  "icon": "assets/mymod/icon.png",

  "environment": "*",
  "entrypoints": {
    "main": [
      "com.example.fabric.MyFabricMod"
    ]
  },
  "mixins": [
    "myfabulousmod.mixins.json"
  ],

  "depends": {
    "fabricloader": ">=0.14.21",
    "fabric-api": "*",
    "minecraft": "~1.20.4",
    "java": ">=17"
  },
  "suggests": {
    "another-mod": "*"
  }
}`;
        } else if (fileName === 'pom.xml') {
          fileContent = `<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.yourname.modid</groupId>
    <artifactId>my-awesome-mod</artifactId>
    <version>1.0-SNAPSHOT</version>
    <packaging>jar</packaging>

    <properties>
        <maven.compiler.source>17</maven.compiler.source>
        <maven.compiler.target>17</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    </properties>

    <dependencies>
        <!-- Minecraft Forge dependency -->
        <dependency>
            <groupId>net.minecraftforge</groupId>
            <artifactId>forge</artifactId>
            <version>1.20.4-49.0.31</version>
            <scope>provided</scope>
        </dependency>
    </dependencies>

    <build>
        <defaultGoal>clean install</defaultGoal>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.11.0</version>
                <configuration>
                    <source>17</source>
                    <target>17</target>
                </configuration>
            </plugin>

            <!-- MCP Mapping -->
            <plugin>
                <groupId>org.moddingtominecraft</groupId>
                <artifactId>gmaven-plugin</artifactId>
                <version>1.0.0</version>
                <executions>
                    <execution>
                        <goals>
                            <goal>decompile</goal>
                            <goal>recompile</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
        </plugins>

        <finalName>\${project.artifactId}-\${project.version}</finalName>
    </build>
</project>`;
        }

        // Add new file with appropriate content
        currentProject.files[fileName] = fileContent;

        // Open the new file in the editor
        currentFile = fileName;

        // Refresh the IDE to show the new file
        initializeProjectIDE();

        showToast('File \'' + fileName + '\' created!', 'success');
      }
    }

    function toggleDeleteMode() {
      deleteMode = !deleteMode;
      if (deleteMode) {
        showToast('Delete mode enabled. Click on a file or folder to delete it.', 'error');
        // In a real implementation, you would highlight deletable items
      } else {
        showToast('Delete mode disabled.', 'success');
      }
    }

    function openFile(fileName) {
      if (deleteMode) {
        // If in delete mode, ask for confirmation to delete the file
        const confirmDelete = confirm('Are you sure you want to delete \'' + fileName + '\'?');
        if (confirmDelete) {
          if (currentProject && currentProject.files) {
            // Remove the file from the project
            delete currentProject.files[fileName];

            // If the deleted file was the current file, clear the editor
            if (currentFile === fileName) {
              currentFile = null;
              const editor = document.getElementById('codeEditor');
              editor.value = '';
            }

            showToast('File \'' + fileName + '\' deleted!', 'success');

            // Refresh the file list
            initializeProjectIDE();
          } else {
            showToast('No project open or no files to delete', 'error');
          }
        }
        // Exit delete mode after interaction
        deleteMode = false;
        return;
      }

      // Open the file in the editor
      currentFile = fileName;

      // Update the editor content from the project files
      const editor = document.getElementById('codeEditor');
      if (currentProject && currentProject.files && currentProject.files[fileName]) {
        editor.value = currentProject.files[fileName];
      } else {
        // If file doesn't exist in project, create it with default content based on extension
        let defaultContent = '';
        if (fileName.endsWith('.js')) {
          defaultContent = 'console.log("Hello from " + "' + fileName + '");\n// Your JavaScript code here\n';
        } else if (fileName.endsWith('.html')) {
          defaultContent = '<!DOCTYPE html>\n<html>\n<head>\n  <title>' + fileName + '</title>\n</head>\n<body>\n  <h1>Hello World</h1>\n</body>\n</html>\n';
        } else if (fileName.endsWith('.css')) {
          defaultContent = 'body {\n  background-color: #020617;\n  color: white;\n}\n\n/* Your CSS styles here */\n';
        } else {
          defaultContent = '// Content for ' + fileName + '\n';
        }

        // Add the file to project with default content
        if (currentProject) {
          if (!currentProject.files) currentProject.files = {};
          currentProject.files[fileName] = defaultContent;
        }

        editor.value = defaultContent;
      }

      // Check for errors in the loaded content
      setTimeout(checkForErrors, 500); // Delay check to allow the content to load
    }

    function saveProject() {
      if (currentProject) {
        try {
          // Check for errors before saving
          const editor = document.getElementById('codeEditor');
          if (editor && editor.value) {
            // Temporarily save the current editor content to the current file
            if (currentFile && currentProject.files) {
              currentProject.files[currentFile] = editor.value;
            }

            if (checkForErrors()) { // If errors are found
              const confirmSave = confirm('Errors detected in your code. Do you still want to save?');
              if (!confirmSave) {
                return; // Don't save if user cancels
              }
            }
          }

          // Save project to localStorage first
          const savedProjects = JSON.parse(localStorage.getItem('savedProjects') || '{}');
          savedProjects[currentProject.name] = currentProject;
          localStorage.setItem('savedProjects', JSON.stringify(savedProjects));

          // Also save to persistent storage for update resilience
          storePersistentData('minecraft_projects', savedProjects);

          // If Firebase is available, also save to Firebase Storage
          if (typeof firebase !== 'undefined' && storage) {
            // Save project to Firebase Storage
            const projectRef = storage.ref('projects/' + currentProject.name + '.json');
            const projectData = JSON.stringify(currentProject);

            projectRef.putString(projectData, 'raw')
              .then((snapshot) => {
                showToast('Project \'' + currentProject.name + '\' saved successfully!', 'success');
              })
              .catch((error) => {
                console.error("Error saving project to Firebase:", error);
                showToast('Project saved locally, but failed to sync to cloud: ' + error.message, 'error');
              });
          } else {
            showToast('Project \'' + currentProject.name + '\' saved successfully!', 'success');
          }
        } catch (error) {
          console.error("Error saving project:", error);
          showToast('Error saving project: ' + error.message, 'error');
        }
      } else {
        showToast('No project to save', 'error');
      }
    }

    function dragBlock(event, blockType) {
      event.dataTransfer.setData("blockType", blockType);
      // Prevent the default behavior to avoid conflicts
      event.preventDefault();
    }

    function dropBlock(event) {
      event.preventDefault();
      const blockType = event.dataTransfer.getData("blockType");
      // Call insertCodeBlock for the dragged item
      insertCodeBlock(blockType);
    }

    // Function to check code for potential errors
    function checkForErrors(showInPanel = false) {
      const editor = document.getElementById('codeEditor');
      if (!editor) return false; // If editor doesn't exist, return false

      const code = editor.value;
      let errorsFound = false;
      let errorMessages = [];
      let warningMessages = []; // Additional warnings

      // Basic syntax error checks
      const errorIndicators = [
        { pattern: /{[^}]*$/, message: 'Unmatched opening brace { - missing closing brace', type: 'syntax' },
        { pattern: /[^{]*}[^{]*$/, message: 'Unmatched closing brace } - missing opening brace', type: 'syntax' },
        { pattern: /function [a-zA-Z_][a-zA-Z0-9_]*\s*\([^)]*$/, message: 'Function declaration missing closing parenthesis', type: 'syntax' },
        { pattern: /\([^)]*$/, message: 'Unmatched opening parenthesis ( - missing closing', type: 'syntax' },
        { pattern: /[^(]*\)[^(]*$/, message: 'Unmatched closing parenthesis ) - missing opening', type: 'syntax' },
        { pattern: /"[^"]*$/, message: 'Unmatched opening quote " - missing closing quote', type: 'syntax' },
        { pattern: /[^"]*"[^"]*$/, message: 'Unmatched closing quote " - missing opening quote', type: 'syntax' },
        { pattern: /'[^']*$/, message: 'Unmatched opening quote \' - missing closing quote', type: 'syntax' },
        { pattern: /[^']*'[^']*$/, message: 'Unmatched closing quote \' - missing opening quote', type: 'syntax' },
        { pattern: /;/g, callback: (code) => {
          // Check for potential missing semicolons in Java
          if (code.includes('public ') || code.includes('private ') || code.includes('protected ') || code.includes('static ')) {
            const lines = code.split('\n');
            for (let i = 0; i < lines.length; i++) {
              const line = lines[i].trim();
              if ((line.includes('public ') || line.includes('private ') || line.includes('protected ') || line.includes('static ')) &&
                  !line.endsWith(';') &&
                  !line.endsWith('{') &&
                  !line.endsWith('}') &&
                  !line.startsWith('/') &&
                  !line.includes('class ') &&
                  !line.includes('interface ') &&
                  !line.includes('enum ')) {
                return 'Missing semicolon at end of statement: ' + line.substring(0, 50) + '...';
              }
            }
          }
          return null;
        }, type: 'syntax' },
        { pattern: /import/, callback: (code) => {
          // Check for incomplete import statements in Java
          const lines = code.split('\n');
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line.startsWith('import ') && !line.endsWith(';')) {
              return 'Incomplete import statement - missing semicolon: ' + line;
            }
          }
          return null;
        }, type: 'syntax' },
      ];

      // Check patterns with callbacks or regular expressions
      for (const indicator of errorIndicators) {
        if (indicator.callback) {
          const result = indicator.callback(code);
          if (result) {
            errorMessages.push(result);
            errorsFound = true;
          }
        } else if (indicator.pattern instanceof RegExp) {
          if (indicator.pattern.test(code)) {
            errorMessages.push(indicator.message);
            errorsFound = true;
          }
        } else if (typeof indicator.pattern === 'string' && code.includes(indicator.pattern)) {
          // Handle string patterns
          if (indicator.pattern === 'import' || indicator.pattern === ';') {
            // Already handled via callback
            continue;
          }
        }
      }

      // Check for more advanced syntax errors
      if (code) {
        // Check for potential variable declaration errors
        const lines = code.split('\n');
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();

          // Check for variables that may be undefined
          if (line.includes('=') && !line.startsWith('function') && !line.includes('var ') && !line.includes('let ') && !line.includes('const ') &&
              !line.includes('public ') && !line.includes('private ') && !line.includes('protected ') && !line.includes('static ')) {
            if (line.includes(' = ') && !line.startsWith('//') && !line.startsWith('/*') && !line.startsWith('*')) {
              // Check if this is an assignment that might use undefined variables
              const parts = line.split('=');
              if (parts.length > 1) {
                const valuePart = parts[1].trim();
                // Look for potential undefined variables in the value part
                if (valuePart && !valuePart.startsWith('"') && !valuePart.startsWith("'") && !valuePart.startsWith('[') &&
                    !valuePart.startsWith('{') && !/^\d+$/.test(valuePart) && !valuePart.startsWith('true') &&
                    !valuePart.startsWith('false') && !valuePart.includes('(')) {
                  // Might contain undefined variables
                  if (valuePart.includes(' ') && !valuePart.includes('+') && !valuePart.includes('-') &&
                      !valuePart.includes('*') && !valuePart.includes('/')) {
                    warningMessages.push('Potential undefined variable usage at line ' + (i+1) + ': ' + line.substring(0, 40) + '...');
                  }
                }
              }
            }
          }

          // Check for missing semicolons in statement contexts
          if ((line.includes('return ') || line.includes('if (') || line.includes('while (') || line.includes('for (')) &&
              !line.endsWith(';') && !line.includes('{') && !line.includes('}') && !line.startsWith('//')) {
            warningMessages.push('Possible missing semicolon at line ' + (i+1) + ': ' + line.substring(0, 40) + '...');
          }
        }
      }

      // Check for common Minecraft-specific issues
      if (code.includes('onEnable')) {
        const hasProperDeclaration = code.includes('function onEnable') ||
                                    code.includes('public void onEnable') ||
                                    code.includes('private void onEnable') ||
                                    code.includes('protected void onEnable');
        if (!hasProperDeclaration) {
          // If the word "onEnable" exists but not as a proper function, it might be an issue
          const onEnableMatches = (code.match(/onEnable/g) || []).length;
          if (onEnableMatches > 0) {  // At least one usage without a proper definition
            errorMessages.push('Potential issue: "onEnable" found but function declaration might be missing or improperly formatted');
            errorsFound = true;
          }
        }
      }

      if (code.includes('onDisable')) {
        const hasProperDeclaration = code.includes('function onDisable') ||
                                    code.includes('public void onDisable') ||
                                    code.includes('private void onDisable') ||
                                    code.includes('protected void onDisable');
        if (!hasProperDeclaration) {
          const onDisableMatches = (code.match(/onDisable/g) || []).length;
          if (onDisableMatches > 0) {
            errorMessages.push('Potential issue: "onDisable" found but function declaration might be missing or improperly formatted');
            errorsFound = true;
          }
        }
      }

      // Check for missing main methods in Java files
      if (code.includes('public class') && !code.includes('public static void main')) {
        if (code.includes('java') || code.includes('.java') || code.includes('import ') || code.includes('package ')) {
          // Likely a Java file without main method
          warningMessages.push('Java class file may be missing main method for standalone execution');
        }
      }

      // Check for possible null pointer exceptions in Java
      if (code.includes('null') && (code.includes('.length') || code.includes('.charAt') || code.includes('.get(') || code.includes('.size()'))) {
        const lines = code.split('\n');
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          if (line.includes('null') && (line.includes('.length') || line.includes('.charAt') || line.includes('.get(') || line.includes('.size()'))) {
            warningMessages.push('Potential null pointer exception at line ' + (i+1) + ': ' + line.substring(0, 50) + '...');
          }
        }
      }

      // Check for common JavaScript mistakes
      if (code.includes('==') && !code.includes('===') && code.includes('if') && code.includes('{') && code.includes('}')) {
        // Check for potential use of == instead of === in comparisons
        const lines = code.split('\n');
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          if (line.includes('==') && !line.includes('===') && line.includes('if')) {
            warningMessages.push('Consider using strict equality (===) instead of (==) at line ' + (i+1) + ': ' + line.substring(0, 50) + '...');
          }
        }
      }

      // Display results
      if (showInPanel) {
        const errorPanel = document.getElementById('errorPanel');
        const errorAnalysis = document.getElementById('errorAnalysis');

        if (errorPanel && errorAnalysis) {
          if (errorsFound || warningMessages.length > 0) {
            errorPanel.classList.remove('hidden');
            let html = '';
            if (errorMessages.length > 0) {
              html += '<div class="text-red-400 font-semibold mb-1">Errors:</div>';
              errorMessages.forEach(msg => {
                html += `<div class="text-red-300 text-xs py-1 border-b border-red-900/50">‚Ä¢ ${msg}</div>`;
              });
            }
            if (warningMessages.length > 0) {
              if (errorMessages.length > 0) html += '<div class="text-yellow-400 font-semibold mt-2 mb-1">Warnings:</div>';
              else html += '<div class="text-yellow-400 font-semibold mb-1">Warnings:</div>';
              warningMessages.forEach(msg => {
                html += `<div class="text-yellow-300 text-xs py-1 border-b border-yellow-900/50">‚Ä¢ ${msg}</div>`;
              });
            }
            errorAnalysis.innerHTML = html;
          } else {
            errorPanel.classList.add('hidden');
            errorAnalysis.innerHTML = 'No errors detected in current file';
          }
        }
      } else {
        // Only show toast if errors were found and we're not displaying in panel
        if (errorsFound) {
          errorMessages.forEach(msg => showToast(msg, 'error'));
        }
        if (warningMessages.length > 0) {
          // Show first warning as toast if no errors were shown
          if (!errorsFound && warningMessages.length > 0) {
            showToast(warningMessages[0], 'warning');
          }
        }
      }

      return errorsFound; // Return whether errors were found
    }

    // Function to analyze a specific file for errors and return detailed information
    function analyzeFileForErrors(content, fileName) {
      let errorCount = 0;
      let errorDetails = [];
      const lines = content.split('\n');

      // Check for syntax errors line by line
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const lineNumber = i + 1;

        // Check for unmatched brackets
        const openBraces = (line.match(/\{/g) || []).length;
        const closeBraces = (line.match(/\}/g) || []).length;
        if (openBraces > closeBraces) {
          errorCount++;
          errorDetails.push('Line ' + lineNumber + ': Unmatched opening brace { - missing closing brace');
        } else if (closeBraces > openBraces) {
          errorCount++;
          errorDetails.push('Line ' + lineNumber + ': Unmatched closing brace } - missing opening brace');
        }

        // Check for unmatched parentheses
        const openParens = (line.match(/\(/g) || []).length;
        const closeParens = (line.match(/\)/g) || []).length;
        if (openParens > closeParens) {
          errorCount++;
          errorDetails.push('Line ' + lineNumber + ': Unmatched opening parenthesis ( - missing closing parenthesis');
        } else if (closeParens > openParens) {
          errorCount++;
          errorDetails.push('Line ' + lineNumber + ': Unmatched closing parenthesis ) - missing opening parenthesis');
        }

        // Check for unmatched quotes
        const doubleQuotes = (line.match(/"/g) || []).length;
        if (doubleQuotes % 2 !== 0) {
          errorCount++;
          errorDetails.push('Line ' + lineNumber + ': Unmatched double quote " - missing closing quote');
        }

        const singleQuotes = (line.match(/'/g) || []).length;
        if (singleQuotes % 2 !== 0) {
          errorCount++;
          errorDetails.push('Line ' + lineNumber + ': Unmatched single quote \' - missing closing quote');
        }

        // Check for common Java/JavaScript syntax issues
        if (fileName.endsWith('.java')) {
          // Check for missing semicolons in Java
          if ((line.includes('public ') || line.includes('private ') || line.includes('protected ') ||
               line.includes('static ') || line.includes('int ') || line.includes('String ') ||
               line.includes('void ') || line.includes('boolean ') || line.includes('float ') ||
               line.includes('double ') || line.includes('char ') || line.includes('long ')) &&
              !line.trim().endsWith(';') && !line.trim().endsWith('{') && !line.trim().endsWith('}') &&
              !line.trim().startsWith('if') && !line.trim().startsWith('for') && !line.trim().startsWith('while') &&
              !line.trim().startsWith('switch') && !line.trim().startsWith('try') && !line.trim().startsWith('else') &&
              !line.trim().startsWith('return') && !line.trim().startsWith('{') && !line.trim().startsWith('}') &&
              !line.trim().startsWith('//') && !line.trim().startsWith('/*') && !line.trim().startsWith('*') &&
              !line.trim().startsWith('class ') && !line.trim().startsWith('interface ') && !line.trim().startsWith('enum ')) {

            if (line.trim() !== '') { // Only add error if line is not empty
              errorCount++;
              errorDetails.push('Line ' + lineNumber + ': Possible missing semicolon: ' + line.trim().substring(0, 50) + (line.trim().length > 50 ? '...' : ''));
            }
          }

          // Check for common Java errors
          if (line.includes('System.out.print') && !line.includes('(') && !line.includes(')') && !line.trim().endsWith(';')) {
            errorCount++;
            errorDetails.push('Line ' + lineNumber + ': Missing parentheses or semicolon in System.out statement: ' + line.trim());
          }
        } else if (fileName.endsWith('.js')) {
          // Check for common JavaScript errors
          if (line.includes('console.log') && !line.includes('(') && !line.includes(')') && !line.trim().endsWith(';')) {
            errorCount++;
            errorDetails.push('Line ' + lineNumber + ': Missing parentheses or semicolon in console.log statement: ' + line.trim());
          }

          // Check for potential undefined variable usage
          const jsVariablePattern = /\b(var|let|const)?\s*([a-zA-Z_$][a-zA-Z0-9_$]*)\s*=\s*([a-zA-Z_$][a-zA-Z0-9_$]*)\b/;
          if (jsVariablePattern.test(line)) {
            const match = line.match(jsVariablePattern);
            if (match && !line.includes('var ') && !line.includes('let ') && !line.includes('const ') &&
                !line.includes('function ') && !line.includes('return')) {
              // This could be an assignment that uses an undefined variable
              const assignedVar = match[2];
              const sourceVar = match[3];

              // Only flag if the source variable hasn't been defined earlier
              let foundDefinition = false;
              for (let j = 0; j < i; j++) {
                const prevLine = lines[j];
                if (prevLine.includes('var ' + sourceVar + ' ') || prevLine.includes('let ' + sourceVar + ' ') ||
                    prevLine.includes('const ' + sourceVar + ' ') || prevLine.includes('function ' + sourceVar) ||
                    prevLine.includes('function ' + sourceVar + '(')) {
                  foundDefinition = true;
                  break;
                }
              }

              if (!foundDefinition && assignedVar !== sourceVar) {
                errorCount++;
                errorDetails.push('Line ' + lineNumber + ': Potential undefined variable usage: ' + sourceVar);
              }
            }
          }
        }

        // Check for other common errors
        if (line.includes('undefined') && !line.includes('//') && !line.includes('typeof') && !line.includes('===') && !line.includes('==')) {
          errorCount++;
          errorDetails.push('Line ' + lineNumber + ': Usage of \'undefined\' detected: ' + line.trim());
        }

        // Check for potential null pointer issues
        if (line.includes('null') && (line.includes('.') || line.includes('['))) {
          errorCount++;
          errorDetails.push('Line ' + lineNumber + ': Potential null pointer access: ' + line.trim());
        }
      }

      // Check for overall file structure issues
      if (fileName.endsWith('.java')) {
        if (lineNumber > 0 && !content.includes('import ') && !content.includes('public class') && !content.includes('package ')) {
          const firstFewLines = lines.slice(0, 10).join(' ');
          if (!firstFewLines.includes('class ') && !firstFewLines.includes('interface')) {
            errorCount++;
            errorDetails.push('File may be missing proper class declaration');
          }
        }
      }

      return { count: errorCount, details: errorDetails };
    }

    function toggleFolder(folderPath) {
      if (!window.expandedDirs) window.expandedDirs = {};

      // Toggle the expanded state
      window.expandedDirs[folderPath] = !window.expandedDirs[folderPath];

      // Refresh the IDE to show the updated tree
      initializeProjectIDE();
    }

    // Function to store data with versioning to maintain persistence across updates
    function storePersistentData(key, data) {
      try {
        // Create a wrapper object with version and timestamp
        const wrappedData = {
          version: '1.0',
          timestamp: Date.now(),
          data: data
        };
        localStorage.setItem(key, JSON.stringify(wrappedData));
      } catch (e) {
        console.error('Error storing persistent data:', e);
      }
    }

    // Function to retrieve persistent data and handle migrations
    function getPersistentData(key, defaultValue = null) {
      try {
        const storedValue = localStorage.getItem(key);
        if (storedValue) {
          const wrappedData = JSON.parse(storedValue);
          // Return the actual data, ignoring version wrapper for now
          return wrappedData.data || defaultValue;
        }
        return defaultValue;
      } catch (e) {
        console.error('Error retrieving persistent data:', e);
        return defaultValue;
      }
    }

    // Load any persisted projects when the app starts
    function loadPersistedProjects() {
      const persistedProjects = getPersistentData('minecraft_projects', {});

      // If we have projects and they're different from current, merge them
      if (Object.keys(persistedProjects).length > 0) {
        // This would be called during initialization to restore projects
        // For now, we'll just store the key for later use
        window.persistedProjects = persistedProjects;
      }
    }

    // Function to convert files to data URLs and store within user profile for cross-device sync
    async function uploadFilesAndGetUrls(files, modId, versionId) {
      const downloadUrls = [];

      if (!files || files.length === 0) {
        return downloadUrls;
      }

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const fileExtension = file.name.split('.').pop();

        try {
          // Convert file to data URL
          const dataUrl = await fileToDataUrl(file);

          // Store file data in the user's profile data for cross-device sync
          const currentUser = getCurrentUser();
          if (currentUser) {
            // Initialize user files array if it doesn't exist
            if (!currentUser.files) {
              currentUser.files = [];
            }

            // Create a unique ID for this file
            const fileId = generateId();
            const fileName = `${modId}_${versionId}_${i}.${fileExtension}`;

            // Add file data to user profile
            currentUser.files.push({
              id: fileId,
              name: fileName,
              data: dataUrl, // Store the actual data URL
              modId: modId,
              versionId: versionId,
              originalName: file.name,
              uploadDate: new Date().toISOString()
            });

            // Update the current user in localStorage, preserving admin status
            const isAdmin = getStoredData(STORAGE_KEYS.IS_ADMIN, false);
            setStoredData(STORAGE_KEYS.IS_ADMIN, isAdmin); // Ensure admin status is preserved
            setStoredData(STORAGE_KEYS.CURRENT_USER, currentUser);

            // Update the users list to persist on other devices
            const allUsers = getStoredData(STORAGE_KEYS.USERS, []);
            const userIndex = allUsers.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
              // Preserve admin status when updating user data
              allUsers[userIndex] = {
                ...currentUser,
                is_admin: allUsers[userIndex].is_admin // Preserve existing admin status
              };
              setStoredData(STORAGE_KEYS.USERS, allUsers);
            }
          }

          // Create a download URL that references the file in user profile
          const downloadUrl = `dataurl://${fileId}`;

          downloadUrls.push({
            platform: 'default',
            download_url: downloadUrl,
            file_name: file.name
          });
        } catch (error) {
          console.error('Error converting file to data URL:', error);
          // If conversion fails, add the file with a placeholder URL
          downloadUrls.push({
            platform: 'default',
            download_url: '#',
            file_name: file.name
          });
        }
      }

      return downloadUrls;
    }

    // Helper function to convert a file to data URL
    function fileToDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = (error) => reject(error);
        reader.readAsDataURL(file);
      });
    }

    // Helper function to get the actual image source for thumbnails
    function getThumbnailSrc(thumbnailUrl) {
      if (thumbnailUrl && thumbnailUrl.startsWith('dataurl://')) {
        // Extract file ID and retrieve from user profile
        const fileId = thumbnailUrl.replace('dataurl://', '');
        const currentUser = getCurrentUser();
        if (currentUser && currentUser.files) {
          const fileData = currentUser.files.find(f => f.id === fileId);
          if (fileData && fileData.data) {
            return `<img src="${fileData.data}" alt="Thumbnail" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" />`;
          }
        }
        // If file not found in user profile, return placeholder
        return `<div class="w-full h-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center"><span class="text-white font-bold text-center px-4">No Image</span></div>`;
      } else {
        // Regular URL
        return `<img src="${thumbnailUrl}" alt="Thumbnail" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" />`;
      }
    }

    // Helper function to get the actual image source for thumbnails with specific sizes
    function getThumbnailSrcForSize(thumbnailUrl, width, height) {
      if (thumbnailUrl && thumbnailUrl.startsWith('dataurl://')) {
        // Extract file ID and retrieve from user profile
        const fileId = thumbnailUrl.replace('dataurl://', '');
        const currentUser = getCurrentUser();
        if (currentUser && currentUser.files) {
          const fileData = currentUser.files.find(f => f.id === fileId);
          if (fileData && fileData.data) {
            return `<img src="${fileData.data}" alt="Thumbnail" class="w-${width} h-${height} rounded-xl object-cover flex-shrink-0" />`;
          }
        }
        // If file not found in user profile, return placeholder
        return `<div class="w-${width} h-${height} rounded-xl flex-shrink-0 bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center"><span class="text-white font-bold text-xs text-center px-2">No Image</span></div>`;
      } else {
        // Regular URL
        return `<img src="${thumbnailUrl}" alt="Thumbnail" class="w-${width} h-${height} rounded-xl object-cover flex-shrink-0" />`;
      }
    }

    // Function to backup account data to a file
    function backupAccountData() {
      const userData = {
        mods: getStoredData(STORAGE_KEYS.MODS, []),
        versions: getStoredData(STORAGE_KEYS.VERSIONS, []),
        users: getStoredData(STORAGE_KEYS.USERS, []),
        current_user: getCurrentUser(),
        is_admin: getStoredData(STORAGE_KEYS.IS_ADMIN, false),
        projects: getStoredData('savedProjects', {}),
        timestamp: new Date().toISOString()
      };

      const dataStr = JSON.stringify(userData, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

      const exportFileName = 'mcmodsandmore_backup_' + new Date().toISOString().slice(0, 19).replace(/:/g, '-') + '.json';

      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileName);
      linkElement.click();

      showToast('Account data backed up successfully!', 'success');
    }

    // Function to restore account data from a file
    function restoreAccountData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';

      input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = JSON.parse(e.target.result);

            if (data.mods !== undefined) setStoredData(STORAGE_KEYS.MODS, data.mods);
            if (data.versions !== undefined) setStoredData(STORAGE_KEYS.VERSIONS, data.versions);
            if (data.users !== undefined) setStoredData(STORAGE_KEYS.USERS, data.users);
            if (data.current_user !== undefined) setStoredData(STORAGE_KEYS.CURRENT_USER, data.current_user);
            if (data.is_admin !== undefined) setStoredData(STORAGE_KEYS.IS_ADMIN, data.is_admin);
            if (data.projects !== undefined) setStoredData('savedProjects', data.projects);

            // Update UI after restore
            updateAuthUI();
            renderPage();

            showToast('Account data restored successfully! Please refresh the page.', 'success');

          } catch (error) {
            console.error('Error restoring account data:', error);
            showToast('Error restoring account data. Invalid file format.', 'error');
          }
        };
        reader.readAsText(file);
      };

      input.click();
    }

    // Function to show data backup instructions
    function showDataBackupInstructions() {
      const instructions = `
        <div class="max-w-2xl mx-auto">
          <h3 class="text-xl font-bold text-white mb-4">How to Backup Your Account Data</h3>

          <div class="space-y-4 text-slate-300">
            <div class="flex items-start gap-3">
              <div class="flex-shrink-0 w-6 h-6 rounded-full bg-purple-500 flex items-center justify-center text-white text-sm">1</div>
              <p>Click the <strong>"Export Data"</strong> button to save your account data to a file on your device.</p>
            </div>

            <div class="flex items-start gap-3">
              <div class="flex-shrink-0 w-6 h-6 rounded-full bg-purple-500 flex items-center justify-center text-white text-sm">2</div>
              <p>Store this file in a safe location on your computer or cloud storage.</p>
            </div>

            <div class="flex items-start gap-3">
              <div class="flex-shrink-0 w-6 h-6 rounded-full bg-purple-500 flex items-center justify-center text-white text-sm">3</div>
              <p>If you lose your account data (clear browser data, switch devices, etc.), click <strong>"Import Data"</strong> and select your backup file.</p>
            </div>

            <div class="flex items-start gap-3">
              <div class="flex-shrink-0 w-6 h-6 rounded-full bg-purple-500 flex items-center justify-center text-white text-sm">4</div>
              <p>Your account, mods, files, and settings will be restored to the state when you created the backup.</p>
            </div>
          </div>

          <div class="mt-6 p-4 bg-amber-500/10 border border-amber-500/30 rounded-lg">
            <h4 class="font-semibold text-amber-300 mb-2">Important Notes:</h4>
            <ul class="text-amber-200 text-sm space-y-1">
              <li>‚Ä¢ Backup files contain sensitive account information - store them securely</li>
              <li>‚Ä¢ Create regular backups to prevent data loss</li>
              <li>‚Ä¢ Backup files include mods, versions, user profiles, and settings</li>
            </ul>
          </div>
        </div>
      `;

      // Create modal
      const modal = document.createElement('div');
      modal.id = 'backupInstructionsModal';
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4';
      modal.innerHTML = `
        <div class="bg-slate-900 border border-slate-700 rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-white">Account Data Backup Instructions</h3>
            <button onclick="document.getElementById('backupInstructionsModal').remove()" class="text-slate-400 hover:text-white">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
          </div>
          <div class="text-slate-400">
            ${instructions}
          </div>
          <div class="mt-6 text-right">
            <button onclick="document.getElementById('backupInstructionsModal').remove()" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg">
              Close
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    // Initialize on script load
    document.addEventListener('DOMContentLoaded', loadPersistedProjects);
  </script>
</body>
</html>